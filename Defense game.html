<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Defense Game</title>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script type="text/javascript">
  var Upgrade={
    name:[["엔진가동","스나이퍼","최적화","암살자"],["파괴자","마피아","분쇄자","악마"],["레드코인","비트코인","암시장","비트코인거래소"],["스트라이커","폭파","암흑에너지","대폭발"],["에너지 전환","악의의 탄환","과학타워","마왕"]],
    cost:[[120,140,540,400],[500,700,1000,1500],[1000,750,1500,2000],[240,400,1800,1200],[1000,750,2000,3000]],
    AbilityTarget:[[1,[0,2],[1,2,3],[2,3]],[0,1,[0,1,2],4],[3,3,3,3],[0,3,1,3],[0,[1,3],3,[0,1,2]]],
    AbilityValue:[[-20,[1 ,20],[-20,30,3],[20,5]],[1,-10,[1,-10,50],0],[0,0,0,0],[2,0,-150,0],[1,[-10,5],0,[1,-20,50]]],
    Description:[["공격속도가<br>빨라집니다.","공격력이 상승하고,<br>사거리가 넓어집니다.","공격속도가 빨라지고,<br>사거리가 넓어지고,<br>탄환의 속도가<br>빨라집니다.","사거리가 넓어지고,<br>탄환속도가<br>빨라집니다."],["공격력이 상승합니다.","공격속도가<br>빨라집니다.","공격력이 증가하고,<br>공격속도가 빨라지고,<br>사거리가 증가합니다.","한번에 두 발을<br>발사합니다."],["적이 죽을 때마다<br>적의 가격만큼<br>돈을 법니다.","라운드가 끝날때<br>150~200달러를 법니다.","적이 죽을 때마다<br>적의 가격의<br>10배만큼 돈을 법니다.","라운드가 끝날때<br>300~500달러를 법니다."],["공격력이 증가합니다.","탄환이 4방향으로<br>퍼져나갑니다.","공격속도가 매우<br>빨라집니다.","탄환이 8방향으로<br>퍼져나갑니다."],["공격력이 상승합니다.","공격속도와<br>탄환 속도가<br>빨라집니다.","한번에 두 발을<br>발사합니다.","공격력이 상승하고,<br>공격속도가 빨라지며,<br>사거리가 증가합니다."]],
    C:[[120,140,500,500],[220,260,700,1000],[1000,750,1500,2000],[240,400,1500,1200],[1000,750,2000,3000]]
  };
  var effect={
    x:[],
    y:[],
    Fx:[],
    Fy:[],
    type:[],
    value:[],
    Delay:[]
  };
  var bullet_DNA={
    hp:[1,1,0,7,2],
    speed:[6,5,0,3,7],
    size:[10,8,0,18,7]
  }
  var bullet={
    hp:[],
    x:[],
    y:[],
    D:[],
    type:[],
    TargetLocation:[],
    target:[],
    speed:[],
    size:[],
    upgrade:[],
    master:[],
    temp:[]
  }
  var enemy_DNA={
    hp:[1,2,3,4,5,6,7,8,10,20,100,125,150],
    speed:[1,1.1,1.2,1.5,1.6,1.6,2,2.1,3,1,1,1.3],
    shape:[0,0,0,0,0,0,0,0,1,1,1,1,1], //0:원,1:사각형
    size:[15,15,15,15,20,20,15,15,15,25,30,50],
    cost:[1,2,3,4,6,7,15,13,20,20,30,50],
    option:[0,0,0,0,0,0,0,0,1,1,1,1],
    value:[0,0,0,0,0,0,0,0,0,0,0,0]
  };
  var tower_DNA={
    R:[150,100,50,100,210],
    cost:[120,300,1000,240,500],
    Delay:[80,40,10000,250,120],
    name:["기본타워","게틀링타워","은행","메가탄타워","유도탄타워"],
    C:[120,300,1000,240,1200]
  };
  var enemy={
    hp:[],
    type:[],
    D:[],
    point:[],
    point_Saver:[],
    x:[],
    y:[],
    cost:[]
  };
  var tower={
    type:[],
    Upgrade:[],
    D:[],
    R:[],
    AttackDelay:[],
    x:[],
    y:[],
    AddBhp:[],
    AddADelay:[],
    AddSpeed:[],
    cost:[],
    target:[]
  };
  var map_DNA={
    start:[[0,500],[0,500],[0,325],[0,150],[400,0]],
    point:[[115,400,115,400,115,400,115,400,115,480],[220,400,220,400,220,480],[750],[100,400,300,400,100,100,200,500],[100,200,300,300,100,200,80,300,420]],
    Devent:[[90,0,90,180,90,0,90,180,90,0],[90,0,90,180,90,0],[90],[90,180,90,0,270,180,90,180],[180,270,180,90,0,270,0,90,180]]
  };
  var map={
    start:[],
    point:[],
    Devent:[],
    pointLocationSaver:[]
  };
  var line={
    content:["설명서에 오신 것을 환영합니다!","타워디펜스란 길을 통해 오는 적들을 플레이어가<br>타워를 전략적으로 설치하여 막아내는 게임입니다.","[게임의 구성]","여기는 맵페이지입니다.<br>START버튼을 누르고 2번째로 만날 페이지이죠.","왼쪽 아래의 화살표로 난이도 설정화면으로 돌아갈 수 있으며,<br>아래의 숫자를 클릭하여 맵들을 둘러볼 수 있습니다.","여긴 인게임 화면입니다.","스페이스바를 누르시거나 START버튼을 클릭하시면<br>적군들이 경로를 따라 옵니다.","(적군이 오는 상태에서 START버튼을 한 번 더 누르시거나<br>스페이스바를 한 번 더 누르시면 배속모드가 됩니다.)","이쪽에 있는 탭에서 타워를 클릭하여<br>끌어다 놓는 식으로 설치 하실 수 있습니다.","그리고 설치한 타워를 클릭하여 판매하거나<br>업그레이드 하실 수 있습니다.","\"타겟\"버튼을 눌러서 타겟을 변경 하실 수도 있습니다.","그리고 HP가 0이되면 죽습니다!","그럼 건투를 빌죠!"],
    color:["#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#D05353","#5353D0"],
    location:[[415,655],[475,555],[415,620],[415,555],[475,555],[475,655],[475,555],[475,555],[475,555],[475,555],[475,555],[475,655],[475,655]],
    size:[50,40,75,35,35,40,35,35,35,35,35,35,40,50,50]
  };
  var mouse={
    x:0,
    y:0,
    click:0
  };
  var Difficulty=0;
  var explain=0;
  var SelectedMap=0;
  var TowerTapEvent=0;
  var fastmod=1;
  var TutorialPage=0;
  var Round_DNA={
    0:[50,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    1:[50,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    2:[30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1],
    3:[30,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    4:[40,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
    5:[30,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3],
    6:[30,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
    7:[30,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
    8:[30,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],
    9:[30,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],
    10:[20,4,4,4,4,4,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3.3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4],
    11:[10,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5],
    12:[15,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
    13:[30,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
    14:[10,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6],
    15:[25,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7],
    16:[50,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7],
    17:[10,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8],
    18:[30,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8],
    19:[50,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],
    20:[30,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8],
    21:[10,9,9,9,9,9,9,9,9,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],
    22:[20,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9],
    23:[30,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10],
    24:[10,10,10,10,10,10,10,10,10,10,8,8,8,8,8,8,8,8,8,8,8],
    25:[50,10,10,10,11],
    26:[20,11,11,11],
    27:[25,11,11,11,11,11,11,11,11,11,11,11,11,11,11],
    28:[10,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11],
    29:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,8,8,8,8,8,8,8,9,9,9,9,9,9,10,10,10,10,11,11] //30라운드!!
  };
  var END={
    x:[],
    y:[],
    D:[],
    Darkness:0,
    Lightness:0,
    Xspeed:[],
    Yspeed:[],
    color:[],
    Animation:0
  }
  var Round=0;
  var Round_summon=1;
  var OnRound=0;
  var EnemySummon=0;
  var money=300;
  var Situation=0;
  var Timer=0;
  var HP=100;
  var Select=-1;
  var ESC=0;
  var SPACE=0;
  var POP=0;
  var ONE=0;
  var page=0;
  var moneySave=0;
  var MoneyRand=0;
  var SelectedTower=-1;
  var RESTART=0;
  window.addEventListener('mousemove',function(e){
    mouse.x=e.x;
    mouse.y=e.y;
  });
  $(document).click(function (evt) {
    mouse.click=1;
  })
  $(document).keydown(function(e) {
    if (e.keyCode==27) {
      ESC=1;
    }else if (e.keyCode==32) {
      SPACE=1;
    }
  }).keyup(function(e) {
    if (e.keyCode==27) {
      ESC=0;
    }else if (e.keyCode==32) {
      SPACE=0;
    }
  });
  function draw(){
    var canvas = document.getElementById("MAIN");
    if(canvas.getContext){
      var ctx = canvas.getContext("2d");
      moneySave=money;
      BG();
      switch (Situation) {
        case 0:
          Start();
          break;
        case 1:
          Timer+=1;
          EnemySummon+=1+fastmod;
          DrawPath();
          InGame();
          for (var i = 0; i < tower.AttackDelay.length; i++) {
            if (tower.AttackDelay[i]!=0) {
              tower.AttackDelay[i]-=1+fastmod;
            }
          }
          if (HP<=0) {
            Situation=4;
          }
          break;
        case 2:
          DifficultyList();
          break;
        case 3:
          MapList();
          break;
        case 4:
          DIE();
          break;
        case 5:
          Tutorial();
          break;
        case 6:
          Clear();
          break;
      }
      if (isNaN(money)) {
        money=moneySave;
      }
      requestAnimationFrame(draw);
    }
    mouse.click=0;
  }
  function DrawTower(type,upgrade,x,y,size,direction){
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.beginPath();
    ctx.fillStyle="#606060";
    ctx.fillRect(x-size/2,y-size/2,size,size);
    ctx.stroke();
    ctx.beginPath();
    ctx.lineWidth=3*(size/50);
    ctx.strokeStyle="#202020";
    ctx.rect(x-size/2,y-size/2,size,size);
    ctx.stroke();
    switch(type){
      case 0:
        if (upgrade[0]>=2) {
          DrawGear(direction,x-size/2,y,size/1.5,);
          DrawGear(direction,x+size/2,y,size/1.5,);
          ctx.beginPath();
          ctx.fillStyle="#606060";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        if (upgrade[1]>=2) {
          ctx.beginPath();
          ctx.fillStyle="#202020";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        if(upgrade[1]>=2){
          ctx.strokeStyle="#202020";
          ctx.lineWidth=1;
          ctx.fillStyle = "#D00000";
          ctx.beginPath();
          ctx.rect(x-size/2,y-size/4,size,size/2);
          ctx.fill();
          ctx.stroke();
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/2-(size/10);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/10+size/10*upgrade[1]),y+Math.sin(Math.PI/180*(direction-90))*(size-size/10+size/10*upgrade[1]));
        ctx.stroke();
        ctx.beginPath();
        ctx.strokeStyle="#868e96";
        ctx.lineWidth=size/2-(size/5);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)+size/10*upgrade[1]),y+Math.sin(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)+size/10*upgrade[1]));
        ctx.stroke();
        ctx.lineWidth=3*(size/50);
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.arc(x,y,size/2-(5*size/50),0,Math.PI * 2);
        if(upgrade[1]>=1){
          ctx.fillStyle = "#D00000";
        }else{
          ctx.fillStyle = "#6060FF";
        }
        ctx.fill();
        ctx.stroke();
        if (upgrade[0]>=1) {
          DrawGear(Timer,x,y,size/1.5,);
        }
        break;
      case 1:
        Size=size/10;
        if (upgrade[1]>=2) {
          ctx.beginPath();
          ctx.fillStyle="#202020";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/2-Size/2;
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*Size-Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*Size-Math.sin(Math.PI/180*direction)*Size);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/15)-Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*(size-size/15)-Math.sin(Math.PI/180*direction)*Size);
        ctx.stroke();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/2-(Size/2);
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*Size+Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*Size+Math.sin(Math.PI/180*direction)*Size);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/15)+Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*(size-size/15)+Math.sin(Math.PI/180*direction)*Size);
        ctx.stroke();
        ctx.beginPath();
        if(upgrade[0]>=2){
          ctx.strokeStyle="#D0D000";
        }else{
          ctx.strokeStyle="#868e96";
        }
        ctx.lineWidth=size/2-Size;
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*Size-Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*Size-Math.sin(Math.PI/180*direction)*Size);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/10)-Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*(size-size/10)-Math.sin(Math.PI/180*direction)*Size);
        ctx.stroke();
        if(upgrade[0]>=2){
          ctx.strokeStyle="#D0D000";
        }else{
          ctx.strokeStyle="#868e96";
        }
        ctx.lineWidth=size/2-(Size);
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*Size+Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*Size+Math.sin(Math.PI/180*direction)*Size);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/10)+Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*(size-size/10)+Math.sin(Math.PI/180*direction)*Size);
        ctx.stroke();
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/2-size/15;
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*Size,y+Math.sin(Math.PI/180*(direction-90))*Size);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*size*1,y+Math.sin(Math.PI/180*(direction-90))*size*1);
        ctx.stroke();
        ctx.beginPath();
        if(upgrade[0]>=2){
          ctx.strokeStyle="#FFFF00";
        }else{
          ctx.strokeStyle="#868e96";
        }
        ctx.lineWidth=size/2-8*size/50;
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*size/5,y+Math.sin(Math.PI/180*(direction-90))*size/5);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size*1-(-size/15+8*size/50)/2),y+Math.sin(Math.PI/180*(direction-90))*(size*1-(-size/15+8*size/50)/2));
        ctx.stroke();
        if (upgrade[0]>=1) {
          DrawGear(direction,move(direction+180,x,y,size/3)[0],move(direction+180,x,y,size/3)[1],size/2,)
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        if (upgrade[1]==1) {
          ctx.fillStyle = "#202020";
        }else if(upgrade[1]==2){
          ctx.fillStyle = "#D00000";
        }else{
          ctx.fillStyle = "#6060FF";
        }
        ctx.lineWidth=3*(size/50);
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-45))*size/2,y+Math.sin(Math.PI/180*(direction-45))*size/2);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction+45))*size/2,y+Math.sin(Math.PI/180*(direction+45))*size/2);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction+135))*size/2,y+Math.sin(Math.PI/180*(direction+135))*size/2);
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction+135))*size/2,y+Math.sin(Math.PI/180*(direction+135))*size/2);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction+225))*size/2,y+Math.sin(Math.PI/180*(direction+225))*size/2);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction+315))*size/2,y+Math.sin(Math.PI/180*(direction+315))*size/2);
        ctx.fill();
        ctx.stroke();
        if (upgrade[0]>=1) {
          ctx.beginPath();
          ctx.lineWidth=size/20;
          ctx.strokeStyle="#202020";
          ctx.moveTo(move(direction+120,x,y,size*2/8)[0],move(direction+120,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction,x,y,size*2/8)[0],move(direction,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*2/8)[0],move(direction-120,x,y,size*2/8)[1]);
          ctx.fillStyle="#FFFF00";
          ctx.fill();
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(move(direction+120,x,y,size*2/8)[0],move(direction+120,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*2/8)[0],move(direction-120,x,y,size*2/8)[1]);
          ctx.stroke();
        }
        break;
      case 2:
        ctx.lineWidth=3*(size/50);
        if (upgrade[1]>=2) {
          DrawGear(Timer,x-size/2,y,size/1.5,);
          DrawGear(Timer,x+size/2,y,size/1.5,);
          ctx.beginPath();
          ctx.fillStyle="#606060";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        if (upgrade[0]>=2) {
          ctx.beginPath();
          ctx.fillStyle="#202020";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        if (upgrade[0]==2) {
          ctx.beginPath();
          ctx.fillStyle = "#D80000";
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/4,size,size/2);
          ctx.fill();
          ctx.stroke();
        }
        ctx.beginPath();
        if (upgrade[0]==0) {
          ctx.fillStyle = "#FFFF00";
        }else if(upgrade[0]==1){
          ctx.fillStyle = "#D80000";
        }else{
          ctx.fillStyle = "#FFFFFF";
        }
        ctx.stroke();
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.arc(x,y,size/2-(5*size/50),0,Math.PI * 2);
        ctx.fill();
        ctx.stroke();
        ctx.font = 30*size/40+"px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "center";
        if (upgrade[1]==0) {
          ctx.fillText("$",x,y+size/2-(10*size/50));
        }else{
          ctx.fillText("B",x,y+size/2-(10*size/50));
          ctx.beginPath();
          ctx.moveTo(x,y-size/2+(10*size/50));
          ctx.lineTo(x,y+size/2-(7*size/50));
          ctx.stroke();
        }
        break;
      case 3:
        if (upgrade[0]==2) {
          DrawGear(direction,x-size/2,y,size/1.5,);
          DrawGear(direction,x+size/2,y,size/1.5,);
          ctx.beginPath();
          ctx.fillStyle="#000000";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#800000";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/1.25-(size/10);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/10),y+Math.sin(Math.PI/180*(direction-90))*(size-size/10));
        ctx.stroke();
        ctx.beginPath();
        if(upgrade[1]==2){
          ctx.strokeStyle="#DFFF00";
        }else{
          ctx.strokeStyle="#868e96";
        }
        ctx.lineWidth=size/1.25-(size/5);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)),y+Math.sin(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)));
        ctx.stroke();
        ctx.lineWidth=3*(size/50);
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.arc(x,y,size/2-(5*size/50),0,Math.PI * 2);
        if(upgrade[0]>=1){
          ctx.fillStyle="#800000";
        }else{
          ctx.fillStyle="#6060FF";
        }
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.arc(x,y,size/2-(10*size/50),0,Math.PI * 2);
        if(upgrade[0]>=1){
          ctx.fillStyle="#FFFF00";
        }else{
          ctx.fillStyle="#6060FF";
        }
        ctx.fill();
        ctx.stroke();
        ctx.strokeStyle="#202020";
        if(upgrade[1]>=1){
          ctx.lineWidth=3*(size/50);
          for(var i=0;i<6;i++){
            ctx.beginPath();
            ctx.moveTo(move(direction-30+60*i,x,y,size/8)[0],move(direction-30+60*i,x,y,size/8)[1]);
            ctx.lineTo(move(direction+60*i,x,y,size/4)[0],move(direction+60*i,x,y,size/4)[1]);
            ctx.lineTo(move(direction+30+60*i,x,y,size/8)[0],move(direction+30+60*i,x,y,size/8)[1]);
            ctx.stroke();
          }
          if (upgrade[1]==2) {
            ctx.lineWidth=size/50;
            for(var i=0;i<6;i++){
              ctx.beginPath();
              ctx.moveTo(move(direction-30+60*i,x,y,size/16)[0],move(direction-30+60*i,x,y,size/16)[1]);
              ctx.lineTo(move(direction+60*i,x,y,size/8)[0],move(direction+60*i,x,y,size/8)[1]);
              ctx.lineTo(move(direction+30+60*i,x,y,size/16)[0],move(direction+30+60*i,x,y,size/16)[1]);
              ctx.stroke();
            }
            ctx.lineWidth=size/50;
            for(var i=0;i<6;i++){
              ctx.beginPath();
              ctx.moveTo(move(direction-30+60*i,x,y,size/32)[0],move(direction-30+60*i,x,y,size/32)[1]);
              ctx.lineTo(move(direction+60*i,x,y,size/16)[0],move(direction+60*i,x,y,size/16)[1]);
              ctx.lineTo(move(direction+30+60*i,x,y,size/32)[0],move(direction+30+60*i,x,y,size/32)[1]);
              ctx.stroke();
            }
          }
        }
        break;
      case 4:
        if (upgrade[1]>=1) {
          ctx.beginPath();
          ctx.fillStyle="#202020";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
        }
        if (upgrade[0]>=2) {
          DrawGear(direction,x-size/2,y,size/1.5,);
          DrawGear(direction,x+size/2,y,size/1.5,);
          ctx.beginPath();
          if(upgrade[1]==0){
            ctx.fillStyle="#606060";
          }else {
            ctx.fillStyle="#202020";
          }
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          if (upgrade[1]>=2) {
            ctx.fillStyle="#FFFF00";
          }else{
            ctx.fillStyle="#20FF20";
          }
          ctx.fillRect(x-size/3,y-size/3,size/1.5,size/1.5);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.rect(x-size/3,y-size/3,size/1.5,size/1.5);
          ctx.stroke();
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/2-(size/10);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/10),y+Math.sin(Math.PI/180*(direction-90))*(size-size/10));
        ctx.stroke();
        ctx.beginPath();
        ctx.strokeStyle="#868e96";
        ctx.lineWidth=size/2-(size/5);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)),y+Math.sin(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)));
        ctx.stroke();
        if (upgrade[1]>=2) {
          ctx.beginPath();
          ctx.lineWidth=size/20;
          ctx.strokeStyle="#202020";
          ctx.moveTo(move(direction+120,x,y,size*4/8)[0],move(direction+120,x,y,size*4/8)[1]);
          ctx.lineTo(move(direction-45,x,y,size*4/8)[0],move(direction-45,x,y,size*4/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*4/8)[0],move(direction-120,x,y,size*4/8)[1]);
          ctx.fillStyle="#D00000";
          ctx.fill();
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=size/20;
          ctx.strokeStyle="#202020";
          ctx.moveTo(move(direction+120,x,y,size*4/8)[0],move(direction+120,x,y,size*4/8)[1]);
          ctx.lineTo(move(direction+45,x,y,size*4/8)[0],move(direction+45,x,y,size*4/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*4/8)[0],move(direction-120,x,y,size*4/8)[1]);
          ctx.fillStyle="#D00000";
          ctx.fill();
          ctx.stroke();
        }
        ctx.beginPath();
        ctx.lineWidth=size/20;
        ctx.strokeStyle="#202020";
        ctx.moveTo(move(direction+120,x,y,size*4/8)[0],move(direction+120,x,y,size*4/8)[1]);
        ctx.lineTo(move(direction,x,y,size*4/8)[0],move(direction,x,y,size*4/8)[1]);
        ctx.lineTo(move(direction-120,x,y,size*4/8)[0],move(direction-120,x,y,size*4/8)[1]);
        if (upgrade[1]>=2) {
          ctx.fillStyle="#D00000";
        }else{
          ctx.fillStyle="#6060FF";
        }
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(move(direction+120,x,y,size*4/8)[0],move(direction+120,x,y,size*4/8)[1]);
        ctx.lineTo(move(direction-120,x,y,size*4/8)[0],move(direction-120,x,y,size*4/8)[1]);
        ctx.stroke();
        if (upgrade[0]>=1) {
          ctx.beginPath();
          ctx.lineWidth=size/20;
          ctx.strokeStyle="#202020";
          ctx.moveTo(move(direction+120,x,y,size*2/8)[0],move(direction+120,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction,x,y,size*2/8)[0],move(direction,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*2/8)[0],move(direction-120,x,y,size*2/8)[1]);
          ctx.fillStyle="#FFFF00";
          ctx.fill();
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(move(direction+120,x,y,size*2/8)[0],move(direction+120,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*2/8)[0],move(direction-120,x,y,size*2/8)[1]);
          ctx.stroke();
        }
        break;
    }
  }
  function move(D,StartX,StartY,value){
    return [StartX+Math.cos(Math.PI/180*(D-90))*value,StartY+Math.sin(Math.PI/180*(D-90))*value]
  }
  function DrawPath() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    drawer={
      direction:map.Devent[0],
      x:map.start[0],
      y:map.start[1]
    };
    ctx.lineWidth=40;
    ctx.strokeStyle="#868e96";
    ctx.beginPath();
    ctx.strokeStyle="#868e96";
    ctx.moveTo(0,drawer.y);
    ctx.stroke();
    map.pointLocationSaver=[];
    for (var i = 0; i < map.point.length; i++) {
      ctx.beginPath();
      drawer.direction=map.Devent[i];
      map.pointLocationSaver.push([drawer.x,drawer.y]);
      if(drawer.direction==0){
        ctx.moveTo(drawer.x,drawer.y+ctx.lineWidth/2);
        drawer.x=drawer.x+Math.cos(Math.PI/180*(map.Devent[i]-90))*map.point[i];
        drawer.y=drawer.y-ctx.lineWidth/2+Math.sin(Math.PI/180*(map.Devent[i]-90))*map.point[i];
      }else if (drawer.direction==90) {
        ctx.moveTo(drawer.x-ctx.lineWidth/2,drawer.y);
        drawer.x=drawer.x+ctx.lineWidth/2+Math.cos(Math.PI/180*(map.Devent[i]-90))*map.point[i];
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map.Devent[i]-90))*map.point[i];
      }else if (drawer.direction==180) {
        ctx.moveTo(drawer.x,drawer.y-ctx.lineWidth/2);
        drawer.x=drawer.x+Math.cos(Math.PI/180*(map.Devent[i]-90))*map.point[i];
        drawer.y=drawer.y+ctx.lineWidth/2+Math.sin(Math.PI/180*(map.Devent[i]-90))*map.point[i];
      }else if (drawer.direction==270) {
        ctx.moveTo(drawer.x+ctx.lineWidth/2,drawer.y);
        drawer.x=drawer.x-ctx.lineWidth/2+Math.cos(Math.PI/180*(map.Devent[i]-90))*map.point[i];
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map.Devent[i]-90))*map.point[i];
      }else{
        ctx.moveTo(drawer.x,drawer.y);
        drawer.x=drawer.x+Math.cos(Math.PI/180*(map.Devent[i]-90))*map.point[i];
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map.Devent[i]-90))*map.point[i];
      }
      ctx.lineTo(drawer.x,drawer.y);
      ctx.stroke();
    }
    map.pointLocationSaver.push([drawer.x,drawer.y]);
  }
  function BG(){
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.fillStyle = "#62911A";
    ctx.fillRect(0,0,1000,650);
  }
  function Start(){
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.fillStyle = "#FFFFFF";
    ctx.font = "100px Arial";
    ctx.textAlign = "center";
    ctx.fillText("타워디펜스 게임", 500, 150);
    /*ctx.fillStyle = "#000000";
    ctx.font = "50px Arial";
    ctx.textAlign = "center";
    ctx.fillText("Made by JM Games", 500, 200);*/
    ctx.fillStyle = "#FFFFFF";
    ctx.fillRect(300,275,400,100);
    ctx.font = "75px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("시작", 500, 350);
    if (307<=mouse.x&&mouse.x<=707&&285<=mouse.y&&mouse.y<=385&&mouse.click) {
      Situation=2;
      page=0;
    }
    ctx.fillStyle = "#FFFFFF";
    ctx.fillRect(300,425,400,100);
    ctx.fillStyle = "#000000";
    ctx.fillText("설명서", 500, 500);
    if (307<=mouse.x&&mouse.x<=707&&435<=mouse.y&&mouse.y<=535&&mouse.click) {
      Situation=5;
      MakeTower(1,200,470,[0,0],0);
    }
  }
  function Write(x,y,text,size,color) {
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.fillStyle = color;
    ctx.textAlign = "center";
    ctx.font = size+"px Arial";
    ctx.fillText(text, x, y-size);
  }
  function Tutorial() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    if (0<=TutorialPage&&TutorialPage<3) {
      ;
    }else if (3<=TutorialPage&&TutorialPage<5) {
      for (var i = 4*page; i < 4*page+4; i++) {
        DrawMiniMap(62+450*(i%2),275*(Math.floor((i%4)/2))-3,50,i);
        ctx.fillStyle="#62911A";
        ctx.beginPath();
        ctx.fillRect(0,0,1000,24);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,276,1000,23);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,551,1000,100);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,0,49,650);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(451,0,48,650);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(450+62+400,0,50,650);
        ctx.stroke();
        ctx.lineWidth=2;
        ctx.strokeStyle="#202020";
        ctx.beginPath();
        ctx.rect(50+450*(i%2),25+275*(Math.floor((i%4)/2)),400,250);
        ctx.stroke();
      }
      for (var i = 0; i <Math.ceil(map_DNA.point.length/4); i++) {
        if (i==0) {
          ctx.beginPath();
          ctx.strokeStyle='rgba(0,0,0,0)';
          ctx.fillStyle="#00DEDF";
          ctx.arc(150+i*50,615,20,0,Math.PI*2);
          ctx.fill();
          ctx.stroke();
        }
        ctx.beginPath();
        ctx.font = "20px Arial";
        ctx.fillStyle = "#000000";
        ctx.textAlign = "center";
        ctx.fillText((i+1)+"",150+50*i,620);
        ctx.stroke();
      }
      ctx.strokeStyle="#202020";
      ctx.fillStyle="#FFFFFF";
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.rect(25,575,100,50);
      ctx.fill();
      ctx.stroke();
      arrow(80,600,50,270);
    }else if (5<=TutorialPage) {
      map.start=map_DNA.start[0];
      map.point=[];
      map.Devent=[];
      for (var j = 0; j < map_DNA.point[0].length; j++) {
        map.point.push(map_DNA.point[0][j]);
        map.Devent.push(map_DNA.Devent[0][j]);
      }
      DrawPath();
      DrawTap(-1);
      if (TutorialPage==8) {
        DrawTower(1,[0,0],200,270,40,0);
        tower.Upgrade[0]=[0,0];
        DrawTowerTap(0);
      }else if (TutorialPage==9||TutorialPage==10) {
        tower.Upgrade[0]=[1,1];
        DrawTower(1,[1,1],200,270,40,0);
        DrawTowerTap(0);
      }
    }
    //여기서부턴 블라인드
    ctx.fillStyle='rgba(0,0,0,0.5)';
    ctx.beginPath();
    ctx.fillRect(0,0,1000,650);
    ctx.stroke();
    //여기서부는 글쓰기
    for(var i=0;i<BrilliantWriting(line.content[TutorialPage],"ALL").length;i++){
      Write(line.location[TutorialPage][0],line.location[TutorialPage][1]+i*line.size[TutorialPage],BrilliantWriting(line.content[TutorialPage],i),line.size[TutorialPage],line.color[TutorialPage]);
    }
    //여기서부턴 화살표
    if (TutorialPage==8) {
      arrow(690,325,50,90);
    }else if (TutorialPage==9||TutorialPage==10) {
      arrow(425,380,50,180);
    }else if (TutorialPage==11) {
      arrow(690,75,50,90);
    }
    if (TutorialPage!=0) {
      ctx.strokeStyle="#202020";
      ctx.fillStyle="#FFFFFF";
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.rect(775,575,100,50);
      ctx.fill();
      ctx.stroke();
      arrow(830,600,50,270);
      if (775<=mouse.x&&mouse.x<875&&575<=mouse.y&&mouse.y<=675&&mouse.click) {
        TutorialPage-=1;
      }
    }
    ctx.strokeStyle="#202020";
    ctx.fillStyle="#FFFFFF";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.rect(875,575,100,50);
    ctx.fill();
    ctx.stroke();
    arrow(915,600,50,90);
    if (875<=mouse.x&&mouse.x<=975&&575<=mouse.y&&mouse.y<=675&&mouse.click) {
      if(TutorialPage==12){
        TutorialPage=0;
        Situation=0;
        tower.x.splice(0,1);
        tower.y.splice(0,1);
        tower.type.splice(0,1);
        tower.Upgrade.splice(0,1);
        tower.R.splice(0,1);
        tower.D.splice(0,1);
        tower.AddBhp.splice(0,1);
        tower.AddADelay.splice(0,1);
        tower.AttackDelay.splice(0,1);
        tower.AddSpeed.splice(0,1);
        tower.cost.splice(0,1);
        tower.target.splice(0,1);
      }else{
        TutorialPage+=1;
      }
    }
  }
  function DIE(){
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.fillStyle = "#FFFFFF";
    ctx.font = "100px Arial";
    ctx.textAlign = "center";
    ctx.fillText("GAME OVER!", 500, 150);
    ctx.fillStyle = "#FFFFFF";
    ctx.fillRect(300,275,400,100);
    ctx.font = "75px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("RESTART", 500, 350);
    for (var i = 0; i < enemy.x.length; i++) {
      enemy.hp.splice(i,1);
      enemy.D.splice(i,1);
      enemy.point.splice(i,1);
      enemy.point_Saver.splice(i,1);
      enemy.type.splice(i,1);
      enemy.x.splice(i,1);
      enemy.y.splice(i,1);
      enemy.cost.splice(i,1);
    }
    for (var i = 0; i < tower.x.length; i++) {
      tower.x.splice(i,1);
      tower.y.splice(i,1);
      tower.type.splice(i,1);
      tower.Upgrade.splice(i,1);
      tower.R.splice(i,1);
      tower.D.splice(i,1);
      tower.AddBhp.splice(i,1);
      tower.AddADelay.splice(i,1);
      tower.AttackDelay.splice(i,1);
      tower.AddSpeed.splice(i,1);
      tower.cost.splice(i,1);
      tower.target.splice(i,1);
    }
    for (var i = 0; i < bullet.type.length; i++) {
      bullet.hp.splice(i,1);
      bullet.x.splice(i,1);
      bullet.y.splice(i,1);
      bullet.D.splice(i,1);
      bullet.type.splice(i,1);
      bullet.TargetLocation.splice(i,1);
      bullet.target.splice(i,1);
      bullet.size.splice(i,1);
      bullet.master.splice(i,1);
      bullet.upgrade.splice(i,1);
      bullet.temp.splice(i,1);
    }
    if (307<=mouse.x&&mouse.x<=707&&285<=mouse.y&&mouse.y<=385&&mouse.click) {
      SelectedMap=0;
      TowerTapEvent=0;
      fastmod=0;
      Select=-1;
      SelectedTower=-1;
      page=0;
      Round=0;
      Round_summon=1;
      OnRound=0;
      EnemySummon=0;
      money=300;
      Timer=0;
      POP=0;
      Situation=2;
      HP=1;
      RESTART=1;
      requestAnimationFrame(draw);
    }
  }
  function Clear() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    DrawPath();
    ShowBullet();
    DrawEveryTower();
    DrawTap(-1);
    ActiveBullet();
    ctx.fillStyle='rgba(0,0,0,'+END.Darkness/100+')';
    ctx.beginPath();
    ctx.fillRect(0,0,1000,650);
    ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,'+END.Lightness/100+')';
    ctx.beginPath();
    ctx.textAlign='center';
    ctx.font="150px Arial";
    ctx.fillText("Clear!",500,155);
    ctx.stroke();
    ctx.lineWidth=25;
    for (var i = 0; i < END.x.length; i++) {
      ctx.strokeStyle=END.color[i];
      ctx.beginPath();
      ctx.moveTo(move(END.D[i],END.x[i],END.y[i],25)[0],move(END.D[i],END.x[i],END.y[i],25)[1]);
      ctx.lineTo(move(END.D[i]+180,END.x[i],END.y[i],25)[0],move(END.D[i]+180,END.x[i],END.y[i],25)[1]);
      ctx.stroke();
      END.D[i]+=Math.random()*4;
      END.x[i]+=END.Xspeed[i];
      END.y[i]-=END.Yspeed[i];
      END.Yspeed[i]-=3;
      END.Xspeed[i]*=0.8;
      console.log(END.x.length);
      if (END.y[i]>650) {
        END.Xspeed.splice(i,1);
        END.Yspeed.splice(i,1);
        END.x.splice(i,1);
        END.y.splice(i,1);
        END.color.splice(i,1);
        END.D.splice(i,1);
      }
    }
    if(END.Darkness<=60){
      END.Darkness+=0.5;
    }else if(END.Lightness<100){
      END.Lightness+=1;
    }else{
      if (307<=mouse.x&&mouse.x<=707&&285<=mouse.y&&mouse.y<=385&&mouse.click) {
        SelectedMap=0;
        TowerTapEvent=0;
        fastmod=0;
        Select=-1;
        SelectedTower=-1;
        page=0;
        Round=0;
        Round_summon=1;
        OnRound=0;
        EnemySummon=0;
        money=300;
        Timer=0;
        POP=0;
        Situation=2;
        HP=1;
        RESTART=1;
        END.Xspeed.splice(0,END.Xspeed.length);
        END.Yspeed.splice(0,END.Yspeed.length);
        END.x.splice(0,END.x.length);
        END.y.splice(0,END.y.length);
        END.color.splice(0,END.color.length);
        END.D.splice(0,END.D.length);
        requestAnimationFrame(draw);
      }
      if(END.Animation==0){
        END.Animation=10;
        R=Math.floor(Math.random()*5);
        for(var i=0;i<R;i++){
          switch (Math.floor(Math.random()*4)) {
            case 0:
              END.color.push("#D00000");
              break;
            case 1:
              END.color.push("#D0D000");
              break;
            case 2:
              END.color.push("#D000D0");
              break;
            case 3:
              END.color.push("#0000D0");
              break;
          }
          switch (Math.floor(Math.random()*2)) {
            case 0:
              END.x.push(1000);
              END.Xspeed.push(-Math.random()*10-20);
              break;
            case 1:
              END.x.push(0);
              END.Xspeed.push(Math.random()*20+40);
              break;
            }
            END.Yspeed.push(Math.random()*10+40);
            END.D.push(Math.random()*360);
            END.y.push(650);
          }
        }else{
          END.Animation-=1;
      }
    };
    ctx.fillStyle='rgba(255,255,255,'+END.Lightness/100+')';
    ctx.fillRect(300,275,400,100);
    ctx.font = "75px Arial";
    ctx.fillStyle='rgba(0,0,0,'+END.Lightness/100+')';
    ctx.textAlign = "center";
    ctx.fillText("RESTART", 500, 350);
  }
  function InGame(){
    if(OnRound==1&&Round<Object.keys(Round_DNA).length){
      if (Round_DNA[Round][0]==0) {
        while (Round_DNA[Round].length>Round_summon) {
          MakeEnemy(Round_DNA[Round][Round_summon]);
          Round_summon+=1;
        }
      }
      if (EnemySummon>=Round_DNA[Round][0]&&Round_DNA[Round].length>Round_summon) {
        MakeEnemy(Round_DNA[Round][Round_summon]);
        Round_summon+=1;
        EnemySummon=0;
      }
      if (enemy.x.length==0&&Round_DNA[Round].length<=Round_summon&&ONE==0) { //라운드가 끝날때 1번 실행됨.
        for (var i = 0; i < tower.x.length; i++) {
          if (tower.type[i]==2) {
            if (tower.Upgrade[i][1]==0) {
              MakeEffect(tower.x[i],tower.y[i],0,100);
              money+=100;
            }else if(tower.Upgrade[i][1]==1){
              MoneyRand=Rand(1,150,200);
              MakeEffect(tower.x[i],tower.y[i],0,MoneyRand);
              money+=MoneyRand;
            }else if(tower.Upgrade[i][1]==2){
              MoneyRand=Rand(1,300,500);
              MakeEffect(tower.x[i],tower.y[i],0,MoneyRand);
              money+=MoneyRand;
            }
          }
        }
        for (var i = 0; i < bullet.type.length; i++) {
          bullet.hp.splice(i,1);
          bullet.x.splice(i,1);
          bullet.y.splice(i,1);
          bullet.D.splice(i,1);
          bullet.type.splice(i,1);
          bullet.TargetLocation.splice(i,1);
          bullet.target.splice(i,1);
          bullet.size.splice(i,1);
          bullet.master.splice(i,1);
          bullet.upgrade.splice(i,1);
          bullet.temp.splice(i,1);
        }
        ONE=1;
      }
      if (enemy.x.length==0&&Round_DNA[Round].length<=Round_summon) {
        money+=POP;
        OnRound=0;
        POP=0;
        Round+=1;
      }
    }else {
      EnemySummon=0;
      Round_summon=1;
    }
    if (Round>=Object.keys(Round_DNA).length) {
      Situation=6;
    }
    if (Round==0&&OnRound==0) {
      arrow(move(map.Devent[0],move(map.Devent[0],map.start[0],map.start[1],Math.cos(Timer/20)*2)[0],move(map.Devent[0],map.start[0],map.start[1],Math.cos(Timer/20)*2)[1],30)[0],move(map.Devent[0],move(map.Devent[0],map.start[0],map.start[1],Math.cos(Timer/20)*2)[0],move(map.Devent[0],map.start[0],map.start[1],Math.cos(Timer/20)*2)[1],30)[1],40,map.Devent[0]);
    }
    MoveEnemy();
    DrawEnemy();
    ShowBullet();
    DrawEveryTower();
    DrawTap(Select);
    ActiveTower();
    ActiveBullet();
    if (Select==-1) {
      TowerClick();
      if (SelectedTower!=-1) {
        var ctx = document.getElementById("MAIN").getContext("2d");
        ctx.fillStyle = 'rgba(20,20, 20, 0.5)';
        ctx.beginPath();
        ctx.strokeStyle="rgba(20,20,20,0.0)";
        ctx.arc(tower.x[SelectedTower],tower.y[SelectedTower],tower.R[SelectedTower],0,Math.PI * 2);
        ctx.fill();
        ctx.stroke();
        DrawTower(tower.type[SelectedTower],tower.Upgrade[SelectedTower],tower.x[SelectedTower],tower.y[SelectedTower],40,tower.D[SelectedTower]);
        TowerTapClick(SelectedTower,mouse.click);
        DrawTowerTap(SelectedTower);
      }
      if (mouse.click) {
        ClickTower();
      }
    }else{
      SelectedTower=-1;
      var ctx = document.getElementById("MAIN").getContext("2d");
      if (!IsTowerColliseWithPath()&&document.getElementById("MAIN").width*3/4-20>=mouse.x&&mouse.y+20<=document.getElementById("MAIN").height&&mouse.y-20>=0&&20<=mouse.x) {
        ctx.fillStyle = 'rgba(20, 0, 0, 0.5)';
      }else {
        ctx.fillStyle = 'rgba(255,20, 20, 0.5)';
      }
      ctx.beginPath();
      ctx.strokeStyle="rgba(20,20,20,0.0)";
      ctx.arc(mouse.x,mouse.y,tower_DNA.R[Select],0,Math.PI * 2);
      ctx.fill();
      ctx.stroke();
      DrawTower(Select,[0,0],mouse.x,mouse.y,40,0);
      if (ESC==1) {
        Select=-1;
      }
      if (mouse.click){
        if(document.getElementById("MAIN").width*3/4>mouse.x&&!IsTowerColliseWithPath()&&document.getElementById("MAIN").width*3/4-20>=mouse.x&&mouse.y+20<=document.getElementById("MAIN").height&&mouse.y-20>=0&&20<=mouse.x){
          tower.type.push(Select);
          tower.Upgrade.push([0,0]);
          tower.x.push(mouse.x);
          tower.y.push(mouse.y);
          tower.D.push(0);
          tower.R.push(tower_DNA.R[Select]);
          tower.AttackDelay.push(0);
          tower.AddBhp.push(0);
          tower.AddADelay.push(0);
          tower.AddSpeed.push(0);
          tower.cost.push(tower_DNA.C[Select]+(tower_DNA.C[Select]*(Difficulty-1)*0.25)*(Difficulty!=4));
          tower.target.push(0);
          money-=tower_DNA.cost[Select];
          tower_DNA.cost[Select]+=Math.floor(tower_DNA.C[Select]*((Difficulty+1)*0.5)*(Difficulty!=4)*0.15);
          Select=-1;
        }else if (document.getElementById("MAIN").width*3/4<=mouse.x) {
          Select=-1;
        }
      }
    }
    ActiveEffect();
  }
  function MakeTower(type,x,y,upgrade,d) {
    tower.type.push(type);
    tower.Upgrade.push(upgrade);
    tower.x.push(x);
    tower.y.push(y);
    tower.D.push(d);
    tower.R.push(tower_DNA.R[type]);
    tower.AddBhp.push(0);
    tower.AddADelay.push(0);
    tower.AttackDelay.push(0);
    tower.cost.push(tower_DNA.cost[type]);
    tower.target.push(0);
  }
  function ActiveTower() {
    for (var i = 0; i < tower.type.length; i++) {
      target=-1;
      if (tower.target[i]==0) { //선두공격
        for (var j = enemy.x.length; j >=0; --j) {
          if (IsRangeInRange(i,j)) {
            target=j;
          }
        }
      }else if (tower.target[i]==1) { //마지막공격
        for (var j = 0; j < enemy.x.length; j++) {
          if (IsRangeInRange(i,j)) {
            target=j;
          }
        }
      }else if (tower.target[i]==2) { //가까운 적 공격
        TargetSelector=Infinity;
        for (var j = 0; j <enemy.x.length; j++) {
          if (IsRangeInRange(i,j) && GetLength([tower.x[i],tower.y[i]],[enemy.x[j],enemy.y[j]])<TargetSelector) {
            TargetSelector=GetLength([tower.x[i],tower.y[i]],[enemy.x[j],enemy.y[j]]);
            target=j;
          }
        }
      }else if (tower.target[i]==3) { //먼 적 공격
        for (var j = 0; j <enemy.x.length; j++) {
          if (IsRangeInRange(i,j) && GetLength([tower.x[i],tower.y[i]],[enemy.x[j],enemy.y[j]])>=TargetSelector) {
            TargetSelector=GetLength([tower.x[i],tower.y[i]],[enemy.x[j],enemy.y[j]]);
            target=j;
          }
        }
      }
      if (target!=-1) {
        tower.D[i]=AngleOfTwoPoint([tower.x[i],tower.y[i]],[enemy.x[target],enemy.y[target]]);
        Shot(i);
      }
    }
  }
  function Shot(TowerNum){
    target=-1;
    TargetSelector=0;
    if (tower.target[TowerNum]==0) { //선두공격
      for (var j = enemy.x.length; j >=0; --j) {
        if (IsRangeInRange(TowerNum,j)) {
          target=j;
        }
      }
    }else if (tower.target[TowerNum]==1) { //마지막공격
      for (var j = 0; j < enemy.x.length; j++) {
        if (IsRangeInRange(TowerNum,j)) {
          target=j;
        }
      }
    }else if (tower.target[TowerNum]==2) { //가까운 적 공격
      TargetSelector=Infinity;
      for (var j = 0; j <enemy.x.length; j++) {
        if (IsRangeInRange(TowerNum,j) && GetLength([tower.x[TowerNum],tower.y[TowerNum]],[enemy.x[j],enemy.y[j]])<TargetSelector) {
          TargetSelector=GetLength([tower.x[TowerNum],tower.y[TowerNum]],[enemy.x[j],enemy.y[j]]);
          target=j;
        }
      }
    }else if (tower.target[TowerNum]==3) { //먼 적 공격
      for (var j = 0; j <enemy.x.length; j++) {
        if (IsRangeInRange(TowerNum,j) && GetLength([tower.x[TowerNum],tower.y[TowerNum]],[enemy.x[j],enemy.y[j]])>=TargetSelector) {
          TargetSelector=GetLength([tower.x[TowerNum],tower.y[TowerNum]],[enemy.x[j],enemy.y[j]]);
          target=j;
        }
      }
    }
    if (target!=-1&&tower.AttackDelay[TowerNum]<=0) {
      bullet.hp.push(bullet_DNA.hp[tower.type[TowerNum]]+tower.AddBhp[TowerNum]);
      bullet.x.push(tower.x[TowerNum]);
      bullet.y.push(tower.y[TowerNum]);
      bullet.D.push(tower.D[TowerNum]);
      bullet.type.push(tower.type[TowerNum]);
      bullet.TargetLocation.push([enemy.x[target],enemy.y[target]]);
      bullet.target.push(target);
      bullet.speed.push(bullet_DNA.speed[tower.type[TowerNum]]+tower.AddSpeed[TowerNum]);
      bullet.size.push(bullet_DNA.size[tower.type[TowerNum]]);
      bullet.master.push(TowerNum);
      bullet.upgrade.push(tower.Upgrade[TowerNum]);
      bullet.temp.push(0);
      if ((tower.type[TowerNum]==4&&tower.Upgrade[TowerNum][0]==2)||(tower.type[TowerNum]==1&&tower.Upgrade[TowerNum][1]==2)) {
        bullet.hp.push(bullet_DNA.hp[tower.type[TowerNum]]+tower.AddBhp[TowerNum]);
        bullet.x.push(tower.x[TowerNum]);
        bullet.y.push(tower.y[TowerNum]);
        bullet.D.push(tower.D[TowerNum]);
        bullet.type.push(tower.type[TowerNum]);
        bullet.TargetLocation.push([enemy.x[target],enemy.y[target]]);
        bullet.target.push(target);
        bullet.speed.push(bullet_DNA.speed[tower.type[TowerNum]]+tower.AddSpeed[TowerNum]);
        bullet.size.push(bullet_DNA.size[tower.type[TowerNum]]);
        bullet.master.push(TowerNum);
        bullet.upgrade.push(tower.Upgrade[TowerNum]);
        bullet.temp.push(0);
      }
      tower.AttackDelay[TowerNum]=tower_DNA.Delay[tower.type[TowerNum]]+tower.AddADelay[TowerNum];
    }
  }
  function ActiveBullet() {
    for (var i = 0; i < bullet.x.length; i++) {
      touch=-1;
      if (isNaN(bullet.D[i])||isNaN(bullet.x[i])||isNaN(bullet.y[i])) {
        bullet.hp.splice(i,1);
        bullet.x.splice(i,1);
        bullet.y.splice(i,1);
        bullet.D.splice(i,1);
        bullet.type.splice(i,1);
        bullet.TargetLocation.splice(i,1);
        bullet.target.splice(i,1);
        bullet.speed.splice(i,1);
        bullet.size.splice(i,1);
        bullet.master.splice(i,1);
        bullet.upgrade.splice(i,1);
        bullet.temp.splice(i,1);
      }
      for (var j = 0; j < enemy.x.length; j++) {
        switch (enemy_DNA.shape[enemy.type[j]]) {
          case 0:
          if(Ccollision(bullet.x[i],bullet.y[i],enemy.x[j],enemy.y[j],bullet.size[i],enemy_DNA.size[enemy.type[j]])){
            touch=j;
          }
          break;
          case 1:
          if(collision(bullet.x[i],bullet.y[i],enemy.x[j],enemy.y[j],enemy_DNA.size[enemy.type[j]],bullet.size[i])){
            touch=j;
          }
          break;
        }
      }
      if (touch!=-1) {
        if (enemy.hp[touch]<=bullet.hp[i]) {
          bullet.hp[i]-=enemy.hp[touch];
          enemy.hp[touch]=0;
        }else if(enemy.hp[touch]>bullet.hp[i]){
          enemy.hp[touch]-=bullet.hp[i];
          if (enemy_DNA.option[enemy.type[touch]]==0) {
            finder=enemy.type[touch]-bullet.hp[i]+1;
            enemy.type[touch]=finder;
            while (enemy_DNA.option[finder]!=0) {
              enemy.type[touch]=finder;
              finder-=1;
            }
          }
          bullet.hp[i]=0;
        }else{
          enemy.hp[touch]-=1;
          bullet.hp[i]-=1;
        }
        if (enemy.hp[touch]!=0) {
          if (enemy_DNA.option[enemy.type[touch]]==0) {
            finder=enemy.type[touch]-1;
            enemy.type[touch]=finder;
            while (enemy_DNA.option[finder]!=0) {
              enemy.type[touch]=finder;
              finder-=1;
            }
          }
        }else if (bullet.type[i]==4 && enemy.type.length!=0) {
          touch=-1;
          for (var j = 0; j < enemy.x.length; j++) {
            switch (enemy_DNA.shape[enemy.type[j]]) {
              case 0:
              if(Ccollision(bullet.x[i],bullet.y[i],enemy.x[j],enemy.y[j],bullet.size[i],enemy_DNA.size[enemy.type[j]])){
                touch=j;
              }
              break;
              case 1:
              if(collision(bullet.x[i],bullet.y[i],enemy.x[j],enemy.y[j],enemy_DNA.size[enemy.type[j]],bullet.size[i])){
                touch=j;
              }
              break;
            }
          }
          if(touch!=-1){
            bullet.target[i]=touch;
          }else{
            bullet.hp[i]=0;
          }
        }
        if(enemy.hp[touch]==0){
          for (var j = 0; j < tower.type.length; j++) {
            if (tower.type[j]==2){
              if(tower.Upgrade[j][0]==1) {
                MakeEffect(tower.x[j],tower.y[j],1,enemy.cost[touch]);
                money+=enemy_DNA.cost[touch];
              }else if(tower.Upgrade[j][0]==2){
                MakeEffect(tower.x[j],tower.y[j],1,enemy.cost[touch]*10);
                money+=enemy_DNA.cost[touch]*10;
              }
            }
          }
        }
      }
      if(bullet.type[i]==4&&bullet.x.length!=0){
        if (isNaN(AngleOfTwoPoint([bullet.x[i],bullet.y[i]],[enemy.x[bullet.target[i]],enemy.y[bullet.target[i]]]))) {
          bullet.hp[i]=0;
        }else{
          bullet.D[i]=AngleOfTwoPoint([bullet.x[i],bullet.y[i]],[enemy.x[bullet.target[i]],enemy.y[bullet.target[i]]]);
        }
      }
      if(bullet.type[i]!=-1){
        if (IsPointInCircle(bullet.x[i],bullet.y[i],bullet.size[i],bullet.TargetLocation[i][0],bullet.TargetLocation[i][1])&&bullet.type[i]==3&&bullet.upgrade[i][1]>=1&&bullet.temp==0) {
          for (var j = 0; j < 4*bullet.upgrade[i][1]; j++) {
            MakeBullet(j*45*(3-bullet.upgrade[i][1]),bullet.x[i],bullet.y[i],10,1,10);
          }
          bullet.temp[i]=1;
        }
      }
      if (bullet.hp[i]<=0||bullet.x[i]<=0||bullet.y[i]<=0||bullet.x[i]>=document.getElementById("MAIN").width||bullet.y[i]>=document.getElementById("MAIN").height) {
        bullet.hp.splice(i,1);
        bullet.x.splice(i,1);
        bullet.y.splice(i,1);
        bullet.D.splice(i,1);
        bullet.type.splice(i,1);
        bullet.TargetLocation.splice(i,1);
        bullet.target.splice(i,1);
        bullet.speed.splice(i,1);
        bullet.size.splice(i,1);
        bullet.master.splice(i,1);
        bullet.upgrade.splice(i,1);
        bullet.temp.splice(i,1);
      }else{
        bullet.x[i]+=Math.cos(Math.PI/180*(bullet.D[i]-90))*(bullet.speed[i]+bullet.speed[i]*fastmod);
        bullet.y[i]+=Math.sin(Math.PI/180*(bullet.D[i]-90))*(bullet.speed[i]+bullet.speed[i]*fastmod);
      }
    }
  }
  function ShowBullet() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    for (var i = 0; i < bullet.x.length; i++) {
      ctx.beginPath();
      ctx.strokeStyle="#202020";
      ctx.fillStyle = "#6060FF";
      ctx.lineWidth = 1;
      ctx.arc(bullet.x[i],bullet.y[i],bullet.size[i],0,Math.PI * 2);
      ctx.fill();
      ctx.stroke();
    }
  }
  function GetLength(Point1,Point2) {
    return Math.sqrt((Point1[0]-Point2[0])**2+(Point1[1]-Point2[1])**2);
  }
  function ClickTower() {
    click=-1;
    for (var i = 0; i < tower.x.length; i++) {
      if (tower.x[i]-20<=mouse.x&&mouse.x<=tower.x[i]+20&&mouse.y<=tower.y[i]+20&&mouse.y>=tower.y[i]-20) {
        click=i;
      }
    }
    if(!(85<=mouse.x&&mouse.x<=690&&mouse.y>=455&&SelectedTower!=-1)&&!(85<=mouse.x&&mouse.x<=290&&mouse.y>=405&&SelectedTower!=-1)){
      SelectedTower=click;
    }
  }
  function IsRangeInRange(TowerNum,EnemyNum) {
    switch (enemy_DNA.shape[enemy.type[EnemyNum]]) {
      case 0:
      if(Ccollision(tower.x[TowerNum],tower.y[TowerNum],enemy.x[EnemyNum],enemy.y[EnemyNum],tower.R[TowerNum],enemy_DNA.size[enemy.type[EnemyNum]])){
        return 1;
      }
      break;
      case 1:
      if(collision(tower.x[TowerNum],tower.y[TowerNum],enemy.x[EnemyNum],enemy.y[EnemyNum],enemy_DNA.size[enemy.type[EnemyNum]],tower.R[TowerNum]-enemy_DNA.size[enemy.type[EnemyNum]]-5)){
        return 1;
      }
      break;
    }
    return 0;
  }
  function AngleOfTwoPoint([ax,ay],[bx,by]) {
    return Math.atan2(by-ay,bx-ax)*180/Math.PI+90;
  }
  function DrawEveryTower() {
    for (var i = 0; i < tower.type.length; i++) {
      DrawTower(tower.type[i],tower.Upgrade[i],tower.x[i],tower.y[i],40,tower.D[i]);
    }
  }
  function IsTowerColliseWithPath() {
    for (var i = 0; i < map.pointLocationSaver.length-1; i++) {
      if (Rcollision([mouse.x-20,mouse.y-20,mouse.x+20,mouse.y+20],[map.pointLocationSaver[i][0]-20,map.pointLocationSaver[i][1]-20,map.pointLocationSaver[i+1][0]+20,map.pointLocationSaver[i+1][1]+20*(map.Devent[i]==90||map.Devent[i]==270)-20*(map.Devent[i]==180||map.Devent[i]==0)])) {
        return 1;
      }
    }
    for (var i = 0; i < tower.x.length; i++) {
      if (Rcollision([mouse.x-20,mouse.y-20,mouse.x+20,mouse.y+20],[tower.x[i]-20,tower.y[i]-20,tower.x[i]+20,tower.y[i]+20])) {
        return 1;
      }
    }
    return 0;
  }
  function DrawEnemy(){
    var ctx = document.getElementById("MAIN").getContext("2d");
    for (var i = 0; i < enemy.x.length; i++) {
      ctx.beginPath();
      switch (enemy.type[i]) {
        case 0:
        ctx.fillStyle = "#FF0000";
        break;
        case 1:
        ctx.fillStyle = "#FF7F00";
        break;
        case 2:
        ctx.fillStyle = "#FFFF00";
        break;
        case 3:
        ctx.fillStyle = "#8B00FF";
        break;
        case 4:
        ctx.fillStyle = "#8B8DFF";
        break;
        case 5:
        ctx.fillStyle = "#FBF8FD";
        break;
        case 6:
        ctx.fillStyle = "#00D3D3";
        break;
        case 7:
        ctx.fillStyle = "#BC8F8F";
        break;
        case 8:
        ctx.fillStyle = "#DAA520";
        break;
        case 9:
        ctx.fillStyle = "#FF0000";
        break;
        case 10:
        ctx.fillStyle = "#8B4513";
        break;
      }
      if (enemy_DNA.shape[enemy.type[i]]==0) {
        ctx.arc(enemy.x[i],enemy.y[i],enemy_DNA.size[enemy.type[i]],0,2*Math.PI);
        ctx.fill();
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#000000';
      }else if (enemy_DNA.shape[enemy.type[i]]==1) {
        ctx.rect(enemy.x[i]-enemy_DNA.size[enemy.type[i]],enemy.y[i]-enemy_DNA.size[enemy.type[i]],enemy_DNA.size[enemy.type[i]]*2,enemy_DNA.size[enemy.type[i]]*2);
        ctx.fill();
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#000000';
      }
      ctx.stroke();
    }
  }
  function MoveEnemy(){
    for (var i = 0; i < enemy.D.length; i++) {
      if (enemy.hp[i]<=0||isNaN(enemy.x[i])) {
        money+=enemy.cost[i];
        POP+=enemy.cost[i];
        enemy.hp.splice(i,1);
        enemy.D.splice(i,1);
        enemy.point.splice(i,1);
        enemy.point_Saver.splice(i,1);
        enemy.type.splice(i,1);
        enemy.x.splice(i,1);
        enemy.y.splice(i,1);
        enemy.cost.splice(i,1);
      }else{
        enemy.x[i]+=Math.cos(Math.PI/180*(enemy.D[i]-90))*(enemy_DNA.speed[enemy.type[i]]+enemy_DNA.speed[enemy.type[i]]*fastmod);
        enemy.y[i]+=Math.sin(Math.PI/180*(enemy.D[i]-90))*(enemy_DNA.speed[enemy.type[i]]+enemy_DNA.speed[enemy.type[i]]*fastmod); //여기부터
        enemy.point[i]+=enemy_DNA.speed[enemy.type[i]]+enemy_DNA.speed[enemy.type[i]]*fastmod;
        if (map.point[enemy.point_Saver[i]]+20<=enemy.point[i]){
          if (map.point[enemy.point_Saver[i]]+20!=enemy.point[i]) {
            enemy.x[i]=map.pointLocationSaver[enemy.point_Saver[i]+1][0];
            enemy.y[i]=map.pointLocationSaver[enemy.point_Saver[i]+1][1];
          }
          enemy.point_Saver[i]+=1;
          enemy.D[i]=map.Devent[enemy.point_Saver[i]];
          enemy.point[i]=0;
          if (enemy.point_Saver[i]==map.point.length) {
            if (Difficulty!=4) {
              HP-=enemy.hp[i];
            }
            enemy.hp.splice(i,1);
            enemy.D.splice(i,1);
            enemy.point.splice(i,1);
            enemy.point_Saver.splice(i,1);
            enemy.type.splice(i,1);
            enemy.x.splice(i,1);
            enemy.y.splice(i,1);
            enemy.cost.splice(i,1);
          }
        }
      }
    }
  }
  function MakeEnemy(type){
    enemy.hp.push(enemy_DNA.hp[type]);
    enemy.cost.push(enemy_DNA.cost[type]);
    enemy.D.push(map.Devent[0]);
    enemy.point.push(0);
    enemy.point_Saver.push(0);
    enemy.type.push(type);
    enemy.x.push(map.start[0]);
    enemy.y.push(map.start[1]);
  }
  function DrawTap(mod){
    var canvas = document.getElementById("MAIN");
    var ctx = document.getElementById("MAIN").getContext("2d");
    if (mod==-1) {
      ctx.beginPath();
      ctx.fillStyle="#964B00";
      ctx.fillRect(canvas.width*3/4,0,canvas.width,canvas.height);
      ctx.stroke();
      ctx.beginPath();
      ctx.lineWidth=5;
      ctx.strokeStyle="#000000";
      ctx.moveTo(canvas.width*3/4,0);
      ctx.lineTo(canvas.width*3/4,canvas.height);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(canvas.width*3/4,canvas.height*1/16);
      ctx.lineTo(canvas.width,canvas.height*1/16);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(canvas.width*3/4,canvas.height*2/16+5);
      ctx.lineTo(canvas.width,canvas.height*2/16+5);
      ctx.stroke();
      ctx.beginPath();
      ctx.fillStyle="#FFFFFF";
      ctx.fillRect(canvas.width*3/4+2.5,canvas.height*14/16+5,canvas.width*1/4-2.5,canvas.height*2/16-5);
      ctx.stroke();
      if (OnRound==0){
        if (Round<Object.keys(Round_DNA).length) {
          ctx.beginPath();
          ctx.fillStyle="#00FF00";
          ctx.strokeStyle="#00FF00";
          ctx.lineWidth=1;
          ctx.moveTo(canvas.width*3/4+7.5,canvas.height*14/16+15);
          ctx.lineTo(canvas.width*3/4+7.5,canvas.height*14/16+70);
          ctx.lineTo(canvas.width*3/4+50,canvas.height*14/16+(15+70)/2);
          ctx.fill();
          ctx.stroke();
          ctx.strokeStyle="#000000";
          ctx.beginPath();
          ctx.font = "50px Arial";
          ctx.fillStyle = "#000000";
          ctx.textAlign = "left";
          ctx.fillText("START",canvas.width*3/4+50,canvas.height*14/16+55);
          ctx.stroke();
        }else{
          ctx.font = "50px Arial";
          ctx.fillStyle = "#000000";
          ctx.textAlign = "left";
          ctx.fillText("THE END",canvas.width*3/4+25,canvas.height*14/16+55);
          ctx.stroke();
        }
      }else if(fastmod==1-RESTART){
        ctx.beginPath();
        ctx.font = "50px Arial";
        ctx.fillStyle = "#2DA0FF";
        ctx.textAlign = "left";
        ctx.fillText("X1",canvas.width*3/4+50,canvas.height*14/16+55);
        ctx.stroke();
      }else if(fastmod==3-RESTART*2){
        ctx.beginPath();
        ctx.font = "50px Arial";
        ctx.fillStyle = "#2DA0FF";
        ctx.textAlign = "left";
        ctx.fillText("X2",canvas.width*3/4+50,canvas.height*14/16+55);
        ctx.stroke();
      }
      ctx.lineWidth=5;
      ctx.beginPath();
      ctx.font = "30px Arial";
      ctx.fillStyle = "#60AF60";
      ctx.textAlign = "left";
      ctx.fillText("$"+money,canvas.width*3/4+2.5,30);
      ctx.stroke();
      ctx.beginPath();
      ctx.font = "30px Arial";
      ctx.fillStyle = "#FF0000";
      ctx.textAlign = "left";
      ctx.fillText("HP : "+HP,canvas.width*3/4+2.5,canvas.height*2/16-5);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(canvas.width*3/4,canvas.height*14/16+5);
      ctx.lineTo(canvas.width,canvas.height*14/16+5);
      ctx.stroke();
      ctx.fillStyle="#FFFFFF";
      for (var i = 0; i < 6; i++) {
        ctx.beginPath();
        ctx.fillRect(canvas.width*3/4+canvas.width*(i%2)/8+canvas.width*((i+1)%2)/64,canvas.width*(Math.floor(i/2)+1)/8+5,canvas.width*1/8-canvas.width*2/64,canvas.width*1/8-canvas.width*2/64);
        ctx.stroke();
        ctx.beginPath();
        ctx.rect(canvas.width*3/4+canvas.width*(i%2)/8+canvas.width*((i+1)%2)/64,canvas.width*(Math.floor(i/2)+1)/8+5,canvas.width*1/8-canvas.width*2/64,canvas.width*1/8-canvas.width*2/64);
        ctx.stroke();
      }
      DrawTower(0,[0,0],canvas.width*3/4+canvas.width*1/16,canvas.width*3/16,50,0);
      DrawTower(1,[0,0],canvas.width*3/4+canvas.width*1/8+canvas.width*3/64,canvas.width*3/16,50,0);
      DrawTower(2,[0,0],canvas.width*3/4+canvas.width*1/16,canvas.width*9.75/32,50,0);
      DrawTower(3,[0,0],canvas.width*3/4+canvas.width*1/8+canvas.width*3/64,canvas.width*9.75/32,50,0);
      DrawTower(4,[0,0],canvas.width*3/4+canvas.width*1/16,canvas.width*9.5/22,50,0);
      ctx.fillStyle="rgba(0,0,0,0.5)";
      for (var i = 0; i < 6; i++) {
        if (tower_DNA.cost[i]>money) {
          ctx.beginPath();
          ctx.fillRect(canvas.width*3/4+canvas.width*(i%2)/8+canvas.width*((i+1)%2)/64,canvas.width*(Math.floor(i/2)+1)/8+5,canvas.width*1/8-canvas.width*2/64,canvas.width*1/8-canvas.width*2/64);
          ctx.stroke();
        }
      }
    }else{
      ctx.beginPath();
      ctx.fillStyle="#964B00";
      ctx.fillRect(canvas.width*3/4,0,canvas.width,canvas.height);
      ctx.stroke();
      ctx.beginPath();
      ctx.lineWidth=5;
      ctx.strokeStyle="#000000";
      ctx.moveTo(canvas.width*3/4,0);
      ctx.lineTo(canvas.width*3/4,canvas.height);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(canvas.width*3/4,canvas.height*1/16);
      ctx.lineTo(canvas.width,canvas.height*1/16);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(canvas.width*3/4,canvas.height*2/16+5);
      ctx.lineTo(canvas.width,canvas.height*2/16+5);
      ctx.stroke();
      ctx.fillStyle="#FFFFFF";
      ctx.beginPath();
      ctx.fillRect(canvas.width*3/4+2.5,canvas.height*2/16+7.5,canvas.width*1/4-2.5,canvas.height*14/16-7.5);
      ctx.stroke();
      ctx.beginPath();
      ctx.font = "50px Arial";
      ctx.fillStyle = "#FF0000";
      ctx.textAlign = "left";
      ctx.fillText("Cancel",canvas.width*6/8,canvas.height*9/16+7.5);
      ctx.stroke();
      ctx.font = "50px Arial";
      ctx.fillStyle = "#FF0000";
      ctx.textAlign = "left";
      ctx.fillText("[ESC]",canvas.width*6/8+10,canvas.height*10/16+7.5);
      ctx.stroke();
      ctx.beginPath();
      ctx.font = "30px Arial";
      ctx.fillStyle = "#60AF60";
      ctx.textAlign = "left";
      ctx.fillText("$"+money,canvas.width*3/4+2.5,30);
      ctx.stroke();
      ctx.beginPath();
      ctx.font = "30px Arial";
      ctx.fillStyle = "#FF0000";
      ctx.textAlign = "left";
      ctx.fillText("HP : "+HP,canvas.width*3/4+2.5,canvas.height*2/16-5);
      ctx.stroke();
    }
  }
  function collision(ox,oy,rx,ry,rs,or){
    if ((rx-rs-or<=ox&& ox<=rx+rs+or)&&(ry-rs-or<=oy&&oy<=ry+rs+or)) {
      return 1;
    }else if (IsPointInCircle(ox,oy,or,rx-rs,ry+rs)) {
      return 1;
    }else if (IsPointInCircle(ox,oy,or,rx+rs,ry+rs)) {
      return 1;
    }else if (IsPointInCircle(ox,oy,or,rx-rs,ry-rs)) {
      return 1;
    }else if (IsPointInCircle(ox,oy,or,rx+rs,ry-rs)) {
      return 1;
    }
    return 0;
  }
  function Ccollision(ax,ay,bx,by,ar,br) {
    if (Math.sqrt((ax-bx)**2+(ay-by)**2)<=ar+br) {
      return 1;
    }
    return 0;
  }
  function TowerClick(){
    var canvas = document.getElementById("MAIN");
    var ctx = canvas.getContext("2d");
    Select=-1;
    for (var i = 0; i < 5; i++) {
      if (canvas.width*3/4+canvas.width*(i%2)/8+canvas.width*((i+1)%2)/64+10<=mouse.x&& mouse.x<=canvas.width*3/4+canvas.width*(i%2)/8+canvas.width*((i+1)%2)/64+5+canvas.width*1/8-canvas.width*2/64 && canvas.width*(Math.floor(i/2)+1)/8+15<=mouse.y&&mouse.y<=canvas.width*(Math.floor(i/2)+1)/8+10+canvas.width*1/8-canvas.width*2/64) {
        ctx.beginPath();
        ctx.strokeStyle='rgba(0,0,0,0)';
        ctx.fillStyle='rgba(20,20,20,0,5)';
        ctx.fillRect(canvas.width*3/4-200,mouse.y-50,200,100);
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#FFFFFF";
        ctx.textAlign = "left";
        ctx.fillText(tower_DNA.name[i],canvas.width*3/4-200,mouse.y-20);
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#FFFFFF";
        ctx.textAlign = "left";
        ctx.fillText("$"+tower_DNA.cost[i],canvas.width*3/4-200,mouse.y+10);
        ctx.stroke();
        if(mouse.click&&tower_DNA.cost[i]<=money){
          Select=i;
          return;
        }
      }
    }
    if ((canvas.width*3/4+2.5<=mouse.x&& mouse.x<=canvas.width&&canvas.height*14/16+5<=mouse.y&&mouse.y<=canvas.height&&mouse.click&&Round<Object.keys(Round_DNA).length)||(SPACE&&Round<Object.keys(Round_DNA).length)) {
      if(OnRound==0){
        fastmod=1-RESTART;
        OnRound=1;
        MakeEffect(400,325,2,Round+1);
        ONE=0;
        SPACE=0;
      }else if (fastmod==1-RESTART) {
        fastmod=3-RESTART*2;
        SPACE=0;
      }else if (fastmod==3-RESTART*2) {
        fastmod=1-RESTART;
        SPACE=0;
      }
    }
  }
  function MakeEffect(x,y,type,value) {
    switch (type) {
      case 0:
        effect.x.push(x);
        effect.y.push(y);
        effect.Fx.push(x);
        effect.Fy.push(y);
        effect.type.push(type);
        effect.value.push(value);
        effect.Delay.push(50);
        break;
      case 1:
        effect.x.push(x);
        effect.y.push(y);
        effect.Fx.push(x);
        effect.Fy.push(y);
        effect.type.push(type);
        effect.value.push(value);
        effect.Delay.push(50);
        break;
      case 2:
        effect.x.push(x);
        effect.y.push(y);
        effect.Fx.push(x);
        effect.Fy.push(y);
        effect.type.push(type);
        effect.value.push(value);
        effect.Delay.push(50);
        break;
    }
  }
  function ActiveEffect() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    for (var i = 0; i < effect.x.length; i++) {
      switch (effect.type[i]) {
        case 0:
          ctx.beginPath();
          ctx.font = "20px Arial";
          ctx.fillStyle = "#60AF60";
          ctx.textAlign = "center";
          ctx.fillText("+$"+effect.value[i],effect.x[i],effect.y[i]-10);
          ctx.stroke();
          if (effect.Fy[i]-30<effect.y[i]) {
            effect.y[i]-=0.5;
          }else if (effect.Delay[i]>0) {
            effect.Delay[i]-=1;
          }else if(effect.Delay[i]<=0){
            effect.x.splice(i,1);
            effect.y.splice(i,1);
            effect.Fx.splice(i,1);
            effect.Fy.splice(i,1);
            effect.type.splice(i,1);
            effect.value.splice(i,1);
            effect.Delay.splice(i,1);
          }
          break;
        case 1:
          ctx.beginPath();
          ctx.font = "20px Arial";
          ctx.fillStyle = "rgba(128,0,0,1.0)";
          ctx.textAlign = "center";
          ctx.fillText("+$"+effect.value[i],effect.x[i],effect.y[i]+10);
          ctx.stroke();
          if (effect.Fy[i]-30<effect.y[i]) {
            effect.y[i]-=0.5;
          }else if (effect.Delay[i]>0) {
            effect.Delay[i]-=1;
          }else if(effect.Delay[i]<=0){
            effect.x.splice(i,1);
            effect.y.splice(i,1);
            effect.Fx.splice(i,1);
            effect.Fy.splice(i,1);
            effect.type.splice(i,1);
            effect.value.splice(i,1);
            effect.Delay.splice(i,1);
          }
          break;
        case 2:
          ctx.beginPath();
          ctx.font = "100px Chalkduster";
          ctx.fillStyle = "rgba(255,255,255,1.0)";
          ctx.textAlign = "center";
          ctx.fillText("Round "+effect.value[i],effect.x[i],effect.y[i]+10);
          ctx.stroke();
          if (effect.Delay[i]>0) {
            effect.Delay[i]-=0.5;
          }else if(effect.Delay[i]<=0){
            effect.x.splice(i,1);
            effect.y.splice(i,1);
            effect.Fx.splice(i,1);
            effect.Fy.splice(i,1);
            effect.type.splice(i,1);
            effect.value.splice(i,1);
            effect.Delay.splice(i,1);
          }
          break;
      }
    }
  }
  function Rcollision(Rect1,Rect2){ //[x1,y1,x2,y2]
    AR={
      L : Rect1[0]*(Rect1[0]<=Rect1[2])+Rect1[2]*(Rect1[0]>Rect1[2]),
      R : Rect1[2]*(Rect1[0]<=Rect1[2])+Rect1[0]*(Rect1[0]>Rect1[2]),
      U : Rect1[1]*(Rect1[1]<=Rect1[3])+Rect1[3]*(Rect1[1]>Rect1[3]),
      D : Rect1[3]*(Rect1[1]<=Rect1[3])+Rect1[1]*(Rect1[1]>Rect1[3])
    }
    BR={
      L : Rect2[0]*(Rect2[0]<=Rect2[2])+Rect2[2]*(Rect2[0]>Rect2[2]),
      R : Rect2[2]*(Rect2[0]<=Rect2[2])+Rect2[0]*(Rect2[0]>Rect2[2]),
      U : Rect2[1]*(Rect2[1]<=Rect2[3])+Rect2[3]*(Rect2[1]>Rect2[3]),
      D : Rect2[3]*(Rect2[1]<=Rect2[3])+Rect2[1]*(Rect2[1]>Rect2[3])
    }
    if (AR.L<=BR.R&&AR.U<=BR.D&&AR.R>=BR.L&&AR.D>=BR.U) {
      return 1;
    }
    return 0;
  }
  function IsPointInCircle(ox,oy,or,px,py){
    return Math.sqrt((ox-px)**2+(oy-py)**2)<=or;
  }
  function Rand(mod,max,min) {
    if(mod==0){
      return Math.random()*(max+1-min)+min;
    }else{
      return Math.floor(Math.random()*(max+1-min)+min);
    }
  }
  function DrawGear(D,x,y,size,mod) {
    var ctx = document.getElementById("MAIN").getContext("2d");
    if (mod==1||mod==undefined) {
      DrawGear(D,x,y,size,0)
    }
    ctx.strokeStyle='rgba(0,0,0,0)';
    if (mod==1||mod==undefined) {
      ctx.fillStyle='#808080';
    }else{
      ctx.fillStyle='#404040';
    }
    ctx.beginPath();
    ctx.arc(x,y,size/2.5-(mod||mod==undefined)*size/40,0,Math.PI*2);
    ctx.fill();
    ctx.stroke();
    if (mod==1||mod==undefined) {
      ctx.strokeStyle='#808080';
    }else{
      ctx.strokeStyle='#404040';
    }
    ctx.lineWidth=size/4-(mod||mod==undefined)*2*size/40;
    for (var i = 0; i < 8; i++) {
      ctx.beginPath();
      ctx.moveTo(x,y);
      ctx.lineTo(move(D-45*i,x,y,size/2-(mod||mod==undefined)*size/40)[0],move(D-45*i,x,y,size/2-(mod||mod==undefined)*size/40)[1]);
      ctx.stroke();
    }
    ctx.strokeStyle='rgba(0,0,0,0)';
    ctx.fillStyle='#404040';
    ctx.beginPath();
    ctx.arc(x,y,size/6,0,Math.PI*2);
    ctx.fill();
    ctx.stroke();
  }
  function DrawTowerTap(select) {
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.beginPath();
    ctx.lineWidth=5;
    ctx.fillStyle="#964B00";
    ctx.fillRect(80,450,600,200);
    ctx.stroke();
    ctx.beginPath();
    ctx.strokeStyle="#202020";
    ctx.rect(80,450,600,200);
    ctx.stroke();
    ctx.beginPath();
    ctx.strokeStyle="#202020";
    ctx.rect(80,400,200,50);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#D00000";
    ctx.rect(80,600,200,50);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#D00000";
    ctx.rect(80,600,200,50);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "30px Arial";
    ctx.fillStyle = "#202020";
    ctx.textAlign = "center";
    ctx.fillText(tower_DNA.name[tower.type[select]],180,485);
    ctx.stroke();
    DrawTower(tower.type[select],tower.Upgrade[select],180,560,60,0);
    ctx.lineWidth=5;
    if(select!=-1){
      if(tower.Upgrade[select][0]!=2){
        ctx.beginPath();
        if(Math.round(Upgrade.cost[tower.type[select]][tower.Upgrade[select][0]*2])<=money){
          ctx.fillStyle="#00D000";
        }else{
          ctx.fillStyle="#808080";
        }
        ctx.strokeStyle="#202020";
        ctx.rect(280,600,200,50);
        ctx.lineWidth=5;
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "center";
        ctx.fillText(Upgrade.name[tower.type[select]][tower.Upgrade[select][0]*2],380,485);
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "center";
        if(TowerTapEvent!=2){
          ctx.fillText("Upgrade",380,637.5);
        }else {
          ctx.fillText("$"+Math.round(Upgrade.cost[tower.type[select]][tower.Upgrade[select][0]*2]),380,637.5);
        }
        ctx.stroke();
        DrawTower(tower.type[select],[tower.Upgrade[select][0]+1,tower.Upgrade[select][1]],380,560,60,0);
        ctx.lineWidth=5;
      }else{
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.fillStyle="#D00000";
        ctx.rect(280,450,200,200);
        ctx.lineWidth=5;
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.fillStyle = "#FFFFFF";
        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        ctx.fillText("이 방향의 업그레이드는",380,485);
        ctx.fillText("모두 완료하였습니다.",380,520);
        ctx.stroke();
      }
      if(tower.Upgrade[select][1]!=2){
        ctx.strokeStyle="#202020";
        if(Math.round(Upgrade.cost[tower.type[select]][tower.Upgrade[select][1]*2+1])<=money){
          ctx.fillStyle="#00D000";
        }else{
          ctx.fillStyle="#808080";
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.rect(480,600,200,50);
        ctx.lineWidth=5;
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "center";
        ctx.fillText(Upgrade.name[tower.type[select]][tower.Upgrade[select][1]*2+1],580,485);
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "center";
        if(TowerTapEvent!=3){
          ctx.fillText("Upgrade",580,637.5);
        }else {
          ctx.fillText("$"+Math.round(Upgrade.cost[tower.type[select]][tower.Upgrade[select][1]*2+1]),580,637.5);
        }
        ctx.stroke();
        DrawTower(tower.type[select],[tower.Upgrade[select][0],tower.Upgrade[select][1]+1],580,560,60,0);
        ctx.lineWidth=5;
      }else{
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.fillStyle="#D00000";
        ctx.rect(480,450,200,200);
        ctx.lineWidth=5;
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.fillStyle = "#FFFFFF";
        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        ctx.fillText("이 방향의 업그레이드는",580,485);
        ctx.fillText("모두 완료하였습니다.",580,520);
        ctx.stroke();
      }
    }
    ctx.strokeStyle="#202020";
    ctx.beginPath();
    ctx.moveTo(280,450);
    ctx.lineTo(280,650);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "30px Arial";
    ctx.fillStyle = "#202020";
    ctx.textAlign = "center";
    if(TowerTapEvent!=1){
      ctx.fillText("판매",180,637.5);
    }else {
      ctx.fillText("+$"+Math.round(tower.cost[select]*7/10),180,637.5);
    }
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "30px Arial";
    ctx.fillStyle = "#202020";
    ctx.textAlign = "center";
    if(TowerTapEvent!=6){
      ctx.fillText("타겟",180,437.5);
    }else {
      switch (tower.target[select]) {
        case 0:
          ctx.fillText("선두",180,437.5);
          break;
        case 1:
          ctx.fillText("마지막",180,437.5);
          break;
        case 2:
          ctx.fillText("근접",180,437.5);
          break;
        case 3:
          ctx.fillText("먼 적군",180,437.5);
          break;
      }
    }
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(480,450);
    ctx.lineTo(480,650);
    ctx.stroke();
    if (TowerTapEvent==4) {
      ctx.beginPath();
      ctx.fillStyle = "#FFFFFF";
      ctx.rect(mouse.x-300,mouse.y,300,150);
      ctx.fill();
      ctx.stroke();
      for (var i = 0; i < BrilliantWriting(Upgrade.Description[tower.type[select]][tower.Upgrade[select][0]*2],"ALL").length; i++) {
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "left";
        ctx.fillText(BrilliantWriting(Upgrade.Description[tower.type[select]][tower.Upgrade[select][0]*2],i),mouse.x-300,mouse.y+30*(i+1));
        ctx.stroke();
      }
    }else if(TowerTapEvent==5){
      ctx.beginPath();
      ctx.fillStyle = "#FFFFFF";
      ctx.rect(mouse.x-300,mouse.y,300,150);
      ctx.fill();
      ctx.stroke();
      for (var i = 0; i < BrilliantWriting(Upgrade.Description[tower.type[select]][tower.Upgrade[select][1]*2+1],"ALL").length; i++) {
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "left";
        ctx.fillText(BrilliantWriting(Upgrade.Description[tower.type[select]][tower.Upgrade[select][1]*2+1],i),mouse.x-300,mouse.y+30*(i+1));
        ctx.stroke();
      }
    }
  }
  function TowerTapClick(select) {
    TowerTapEvent=0;
    if (90<=mouse.x&&mouse.x<=285&&mouse.y>=595) {
      TowerTapEvent=1;
      if (mouse.click) {
        money+=Math.round(tower.cost[select]*7/10);
        tower.x.splice(select,1);
        tower.y.splice(select,1);
        tower.type.splice(select,1);
        tower.Upgrade.splice(select,1);
        tower.R.splice(select,1);
        tower.D.splice(select,1);
        tower.AddBhp.splice(select,1);
        tower.AddADelay.splice(select,1);
        tower.AttackDelay.splice(select,1);
        tower.AddSpeed.splice(select,1);
        tower.cost.splice(select,1);
        tower.target.splice(select,1);
        SelectedTower=-1;
      }
    }else if (290<=mouse.x&&mouse.x<=485&&mouse.y>=595&&tower.Upgrade[select][0]!=2) {
      TowerTapEvent=2;
      if (mouse.click&&Upgrade.cost[tower.type[select]][tower.Upgrade[select][0]*2]<=money) {
        if (typeof(Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][0]*2])=="number") {
          switch (Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][0]*2]) {
            case 0:
              tower.AddBhp[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2];
              break;
            case 1:
              tower.AddADelay[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2];
              break;
            case 2:
              tower.R[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2];
              break;
            case 3:
              tower.AddSpeed[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2];
              break;
          }
        }else{
          for (var i = 0; i < Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][0]*2].length; i++) {
            switch (Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][0]*2][i]) { //0:bullet_hp,1:delay,2:Range,3:special
              case 0:
                tower.AddBhp[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2][i];
                break;
              case 1:
                tower.AddADelay[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2][i];
                break;
              case 2:
                tower.R[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2][i];
                break;
              case 3:
                tower.AddSpeed[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2][i];
                break;
            }
          }
        }
        tower.cost[select]+=Upgrade.cost[tower.type[select]][tower.Upgrade[select][0]*2];
        money-=Math.round(Upgrade.cost[tower.type[select]][tower.Upgrade[select][0]*2]);
        tower.Upgrade[select][0]+=1;
      }
    }else if (490<=mouse.x&&mouse.x<=685&&mouse.y>=595&&tower.Upgrade[select][1]!=2) {
      TowerTapEvent=3;
      if (mouse.click&&Upgrade.cost[tower.type[select]][tower.Upgrade[select][1]*2+1]<=money) {
        if (typeof(Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][1]*2+1])=="number") {
          switch (Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][1]*2+1]) {
            case 0:
              tower.AddBhp[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1];
              break;
            case 1:
              tower.AddADelay[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1];
              break;
            case 2:
              tower.R[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1];
              break;
            case 3:
              tower.AddSpeed[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1];
              break;
          }
        }else{
          for (var i = 0; i < Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][1]*2+1].length; i++) {
            switch (Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][1]*2+1][i]) { //0:bullet_hp,1:delay,2:Range,3:special
              case 0:
                tower.AddBhp[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1][i];
                break;
              case 1:
                tower.AddADelay[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1][i];
                break;
              case 2:
                tower.R[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1][i];
                break;
              case 3:
                tower.AddSpeed[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1][i];
                break;
            }
          }
        }
        tower.cost[select]+=Upgrade.cost[tower.type[select]][tower.Upgrade[select][1]*2+1];
        money-=Math.round(Upgrade.cost[tower.type[select]][tower.Upgrade[select][1]*2+1]);
        tower.Upgrade[select][1]+=1;
      }
    }else if(290<=mouse.x&&mouse.x<=485&&450<=mouse.y&&mouse.y<=600&&tower.Upgrade[select][0]!=2){//ctx.rect(280,600,200,50);ctx.rect(480,600,200,50);ctx.fillRect(80,450,600,200);
      TowerTapEvent=4;
    }else if (490<=mouse.x&&mouse.x<=690&&450<=mouse.y&&mouse.y<=600&&tower.Upgrade[select][1]!=2) {
      TowerTapEvent=5;
    }else if (90<=mouse.x&&mouse.x<=285&&mouse.y<505&&mouse.y>=400){
      TowerTapEvent=6;
      if (mouse.click) {
        tower.target[select]=(tower.target[select]+1)%3;
      }
    }
  }
  function MakeBullet(D,x,y,size,hp,speed) {
    bullet.hp.push(hp);
    bullet.x.push(x);
    bullet.y.push(y);
    bullet.D.push(D);
    bullet.type.push(-1);
    bullet.TargetLocation.push([0,0]);
    bullet.target.push(0);
    bullet.speed.push(speed);
    bullet.size.push(size);
    bullet.master.push(-1);
    bullet.upgrade.push([2,2]);
    bullet.temp.push(0);
  }
  function DifficultyList() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.lineWidth=2;
    ctx.fillStyle="#00FF00";
    ctx.strokeStyle="#202020";
    ctx.beginPath();
    ctx.rect(25,100,250,150);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#FF8F00";
    ctx.rect(325,100,350,150);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#FF0000";
    ctx.rect(725,100,250,150);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#800000";
    ctx.rect(25,300,250,150);
    ctx.fill();
    ctx.stroke();
    /*ctx.beginPath();
    ctx.fillStyle="#DEB887";
    ctx.rect(325,300,350,150);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#808080";
    ctx.rect(725,300,250,150);
    ctx.fill();
    ctx.stroke();*/
    ctx.beginPath();
    ctx.font = "100px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("쉬움",25+125,100+100);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "100px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("보통",325+175,100+75+30);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "75px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("어려움",725+125,100+75+30);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "100px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("지옥",25+125,300+100);
    ctx.stroke();
    /*ctx.beginPath();
    ctx.font = "100px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("샌드박스",325+175,300+100);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "100px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("∞",725+125,300+100);
    ctx.stroke();*/
    ctx.beginPath();
    ctx.font = "80px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("<난이도&모드 선택>",500,75);
    ctx.stroke();
    /*ctx.beginPath();
    ctx.fillStyle="#FFFFFF";
    ctx.fillRect(325+175/2,300+75/2,175,75);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#FFFFFF";
    ctx.fillRect(725+40,300+75/2,175,75);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "50px Arial";
    ctx.fillStyle = "#D00000";
    ctx.textAlign = "center";
    ctx.fillText("준비안됨",325+175,300+100);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "50px Arial";
    ctx.fillStyle = "#D00000";
    ctx.textAlign = "center";
    ctx.fillText("준비안됨",725+125,300+100);
    ctx.stroke();*/
    if (25<=mouse.x&&mouse.x<=25+250&&100<=mouse.y&&mouse.y<=100+150) {
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(25,100,250,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        Difficulty=0;
        money=300;
        HP=125;
        for (var i = 0; i < tower_DNA.C.length; i++) {
          tower_DNA.cost[i]=tower_DNA.C[i]*0.75;
        }
        for (var i = 0; i < Upgrade.C.length; i++) {
          for (var j = 0; j < Upgrade.C[i].length; j++) {
            Upgrade.cost[i][j]=Upgrade.C[i][j]*0.75;
          }
        }
        Situation=3;
      }
    }else if(325<=mouse.x&&mouse.x<=325+350&&100<=mouse.y&&mouse.y<=100+150){
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(325,100,350,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        Difficulty=1;
        money=300;
        Situation=3;
      }
    }else if (725<=mouse.x&&mouse.x<=725+250&&100<=mouse.y&&mouse.y<=100+150) {
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(725,100,250,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        HP=75;
        money=500;
        Difficulty=2;
        for (var i = 0; i < tower_DNA.C.length; i++) {
          tower_DNA.cost[i]=tower_DNA.C[i]*1.25;
        }
        for (var i = 0; i < Upgrade.C.length; i++) {
          for (var j = 0; j < Upgrade.C[i].length; j++) {
            Upgrade.cost[i][j]=Upgrade.C[i][j]*1.25;
          }
        }
        Situation=3;
      }
    }else if (25<=mouse.x&&mouse.x<=25+250&&300<=mouse.y&&mouse.y<=300+150) {
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(25,300,250,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        HP=10;
        money=600;
        Difficulty=3;
        for (var i = 0; i < tower_DNA.C.length; i++) {
          tower_DNA.cost[i]=tower_DNA.C[i]*1.5;
        }
        for (var i = 0; i < Upgrade.C.length; i++) {
          for (var j = 0; j < Upgrade.C[i].length; j++) {
            Upgrade.cost[i][j]=Upgrade.C[i][j]*1.5;
          }
        }
        Situation=3;
      }
    }/*else if (325<=mouse.x&&mouse.x<=325+350&&300<=mouse.y&&mouse.y<=300+150) {
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(325,300,350,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        Difficulty=4;
        for (var i = 0; i < tower_DNA.cost.length; i++) {
          tower_DNA.cost[i]=0;
        }
        for (var i = 0; i < Upgrade.cost.length; i++) {
          for (var j = 0; j < Upgrade.cost[i].length; j++) {
            Upgrade.cost[i][j]=0;
          }
        }
        Situation=3;
      }
    }else if (725<=mouse.x&&mouse.x<=725+250&&300<=mouse.y&&mouse.y<=300+150) {
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(725,300,250,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        Difficulty=5;
        //Situation=3;
      }
    }*/
  }
  function MapList() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    if(page==Math.ceil((map_DNA.point.length+1)/4)-1){
      for (var i = 4*page; i < 4*page+map_DNA.point.length%4; i++) {
        DrawMiniMap(50+450*(i%2)+12,25+275*(Math.floor((i%4)/2))-28,50,i);
        ctx.fillStyle="#62911A";
        ctx.beginPath();
        ctx.fillRect(0,0,1000,24);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,276,1000,50);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,551,1000,100);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,0,49,650);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(451,0,48,650);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(450+62+400,0,50,650);
        ctx.stroke();
        ctx.lineWidth=2;
        ctx.strokeStyle="#202020";
        ctx.beginPath();
        ctx.rect(50+450*(i%2),25+275*(Math.floor((i%4)/2)),400,250);
        ctx.stroke();
        if (50+450*(i%2)<=mouse.x&&mouse.x<=450+450*(i%2)&&25+275*(Math.floor((i%4)/2))<=mouse.y&&mouse.y<=275+275*(Math.floor((i%4)/2))) {
          ctx.fillStyle="rgba(255,255,255,0.5)";
          ctx.beginPath();
          ctx.fillRect(50+450*(i%2),25+275*(Math.floor((i%4)/2)),400,250);
          ctx.stroke();
          if(mouse.click){
            Situation=1;
            map.start=map_DNA.start[i];
            map.point=[];
            map.Devent=[];
            for (var j = 0; j < map_DNA.point[i].length; j++) {
              map.point.push(map_DNA.point[i][j]);
              map.Devent.push(map_DNA.Devent[i][j]);
            }
          }
        }
      }
    }else {
      for (var i = 4*page; i < 4*page+4; i++) {
        DrawMiniMap(62+450*(i%2),275*(Math.floor((i%4)/2))-3,50,i);
        ctx.fillStyle="#62911A";
        ctx.beginPath();
        ctx.fillRect(0,0,1000,24);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,276,1000,23);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,551,1000,100);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,0,49,650);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(451,0,48,650);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(450+62+400,0,50,650);
        ctx.stroke();
        ctx.lineWidth=2;
        ctx.strokeStyle="#202020";
        ctx.beginPath();
        ctx.rect(50+450*(i%2),25+275*(Math.floor((i%4)/2)),400,250);
        ctx.stroke();
        if (50+450*(i%2)<=mouse.x&&mouse.x<=450+450*(i%2)&&25+275*(Math.floor((i%4)/2))<=mouse.y&&mouse.y<=275+275*(Math.floor((i%4)/2))) {
          ctx.fillStyle="rgba(255,255,255,0.5)";
          ctx.beginPath();
          ctx.fillRect(50+450*(i%2),25+275*(Math.floor((i%4)/2)),400,250);
          ctx.stroke();
          if(mouse.click){
            Situation=1;
            map.start=map_DNA.start[i];
            map.point=[];
            map.Devent=[];
            for (var j = 0; j < map_DNA.point[i].length; j++) {
              map.point.push(map_DNA.point[i][j]);
              map.Devent.push(map_DNA.Devent[i][j]);
            }
          }
        }
      }
    }
    ctx.strokeStyle="#202020";
    ctx.fillStyle="#FFFFFF";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.rect(25,575,100,50);
    ctx.fill();
    ctx.stroke();
    arrow(80,600,50,270);
    for (var i = 0; i <Math.ceil(map_DNA.point.length/4); i++) {
      if (page==i) {
        ctx.beginPath();
        ctx.strokeStyle='rgba(0,0,0,0)';
        ctx.fillStyle="#00DEDF";
        ctx.arc(150+i*50,615,20,0,Math.PI*2);
        ctx.fill();
        ctx.stroke();
      }
      ctx.beginPath();
      ctx.font = "20px Arial";
      ctx.fillStyle = "#000000";
      ctx.textAlign = "center";
      ctx.fillText((i+1)+"",150+50*i,620);
      ctx.stroke();
      if (IsPointInCircle(150+i*50,615,20,mouse.x,mouse.y)&&mouse.click) {
        page=i;
      }
    }
    if (mouse.click&&25<=mouse.x&&mouse.x<=125&&575<=mouse.y&&mouse.y<=625) {
      Situation=2;
    }
  }
  function DrawMiniMap(x,y,size,MapType) {
    var ctx = document.getElementById("MAIN").getContext("2d");
    drawer={
      direction:map_DNA.Devent[MapType][0],
      x:x+map_DNA.start[MapType][0]*size/100,
      y:y+map_DNA.start[MapType][1]*size/100
    };
    ctx.lineWidth=40*size/100;
    ctx.strokeStyle="#868e96";
    ctx.beginPath();
    ctx.strokeStyle="#868e96";
    ctx.moveTo(x,drawer.y);
    ctx.stroke();
    map.pointLocationSaver=[];
    for (var i = 0; i < map_DNA.point[MapType].length; i++) {
      ctx.beginPath();
      drawer.direction=map_DNA.Devent[MapType][i];
      map.pointLocationSaver.push([drawer.x,drawer.y]);
      if(drawer.direction==0){
        ctx.moveTo(drawer.x,drawer.y+ctx.lineWidth/2);
        if (map_DNA.point[MapType][i]<440) {
          drawer.x=drawer.x+Math.cos(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
          drawer.y=drawer.y-ctx.lineWidth/2+Math.sin(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
        }else{
          drawer.x=drawer.x+Math.cos(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*440*size/100;
          drawer.y=drawer.y-ctx.lineWidth/2+Math.sin(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*440*size/100;
        }
      }else if (drawer.direction==90) {
        ctx.moveTo(drawer.x-ctx.lineWidth/2,drawer.y);
        drawer.x=drawer.x+ctx.lineWidth/2+Math.cos(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
      }else if (drawer.direction==180) {
        ctx.moveTo(drawer.x,drawer.y-ctx.lineWidth/2);
        drawer.x=drawer.x+Math.cos(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
        drawer.y=drawer.y+ctx.lineWidth/2+Math.sin(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
      }else if (drawer.direction==270) {
        ctx.moveTo(drawer.x+ctx.lineWidth/2,drawer.y);
        drawer.x=drawer.x-ctx.lineWidth/2+Math.cos(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
      }else{
        ctx.moveTo(drawer.x,drawer.y);
        drawer.x=drawer.x+Math.cos(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
      }
      ctx.lineTo(drawer.x,drawer.y);
      ctx.stroke();
    }
    map.pointLocationSaver.push([drawer.x,drawer.y]);
  }
  function arrow(x,y,size,direction){
    var ctx = document.getElementById("MAIN").getContext("2d");
    M=size/50;
    ctx.lineWidth=2*M;
    ctx.fillStyle="#FF0000";
    ctx.strokeStyle="#202020";
    ctx.beginPath();
    ctx.moveTo(move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction+180,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction+180,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction+180,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction+180,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction+90,move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1],10*M)[0],move(direction+90,move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1],10*M)[1]);
    ctx.lineTo(move(direction,x,y,40*M)[0],move(direction,x,y,40*M)[1]);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(move(direction,x,y,40*M)[0],move(direction,x,y,40*M)[1]);
    ctx.lineTo(move(direction-90,move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1],10*M)[0],move(direction-90,move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1],10*M)[1]);
    ctx.lineTo(move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction+180,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction+180,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction+180,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction+180,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.fill();
    ctx.stroke();
    ctx.strokeStyle='rgba(0,0,0,0)';
    ctx.beginPath();
    ctx.moveTo(move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction,x,y,40*M)[0],move(direction,x,y,40*M)[1]);
    ctx.lineTo(move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(x,y);
    ctx.lineTo(move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.fill();
    ctx.stroke();
  }
  function BrilliantWriting(text,line) {
    BR=[];
    TEXT=[];
    if(text.length>=4){
      for (var i = 0; i < text.length-4; i++) {
        if (text[i]+text[i+1]+text[i+2]+text[i+3]=="<br>") {
          BR.push(i);
          i+=4;
        }
      }
      for (var i = 0; i < BR.length; i++) {
        if (i==0) {
          TEXT.push(text.substring(0,BR[i]));
        }else{
          TEXT.push(text.substring(BR[i-1]+4,BR[i]));
        }
      }
      TEXT.push(text.substring(BR[BR.length-1]+4));
      if(line=="ALL"){
        return TEXT;
      }else{
        return TEXT[line];
      }
    }else{
      return text;
    }
  }
  </script>
</head>
<body onload="draw()">
  <canvas id="MAIN" width="1000" height="650"></canvas>
</body>
</html>
