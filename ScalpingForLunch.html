<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì ì‹¬ì‹œê°„ì— ì½”ì¸í•˜ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #111827; /* Dark bg */
            color: #e5e7eb;
            overflow: hidden; /* PC Default: No scrolling */
            user-select: none; /* ë“œë˜ê·¸ ë°©ì§€ */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }

        .up-color { color: #ff4d4d; }
        .down-color { color: #4d79ff; }
        .bg-up { background-color: #ff4d4d; }
        .bg-down { background-color: #4d79ff; }

        .blink-red { animation: blinkRed 0.3s; }
        .blink-blue { animation: blinkBlue 0.3s; }

        @keyframes blinkRed {
            0% { background-color: rgba(255, 77, 77, 0.5); }
            100% { background-color: transparent; }
        }
        @keyframes blinkBlue {
            0% { background-color: rgba(77, 121, 255, 0.5); }
            100% { background-color: transparent; }
        }

        /* Grid Layout (PC Default) */
        .game-grid {
            display: grid;
            grid-template-columns: 280px 1fr 320px; /* ìš°ì¸¡ íŒ¨ë„ ë„ˆë¹„ ì•½ê°„ ì¦ê°€ */
            grid-template-rows: 1fr 200px;
            gap: 0.75rem;
            height: calc(100vh - 70px);
            padding: 0.75rem;
        }
        
        /* Mobile & Tablet Layout Adjustment */
        @media (max-width: 1024px) {
            body {
                overflow-y: auto; 
                overflow-x: hidden;
            }

            .game-grid {
                display: flex;
                flex-direction: column;
                height: auto;
                min-height: calc(100vh - 70px);
                padding-bottom: 2rem; 
            }

            /* DOM ìˆœì„œ: 1.ë¦¬ìŠ¤íŠ¸, 2.ì°¨íŠ¸, 3.ì£¼ë¬¸, 4.í¬íŠ¸í´ë¦¬ì˜¤ */
            /* ëª¨ë°”ì¼ ìš°ì„ ìˆœìœ„: ì°¨íŠ¸ > ì£¼ë¬¸ > ë‚´ëˆ > ë¦¬ìŠ¤íŠ¸ */
            
            .game-grid > section:nth-child(2) { /* ì°¨íŠ¸ */
                order: 1;
                height: 300px; 
                flex: none;
            }

            .game-grid > section:nth-child(3) { /* ì£¼ë¬¸ */
                order: 2;
                flex: none;
            }

            .game-grid > section:nth-child(4) { /* í¬íŠ¸í´ë¦¬ì˜¤ */
                order: 3;
                height: 200px;
                flex: none;
            }

            .game-grid > section:nth-child(1) { /* ë¦¬ìŠ¤íŠ¸ */
                order: 4;
                height: 250px;
                flex: none;
                margin-bottom: 20px;
            }

            header h1 { font-size: 1.1rem; }
            header .text-xl { font-size: 1rem; }
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .beast-font {
            font-family: 'Black Han Sans', sans-serif;
        }

        /* Intro Transitions */
        .fade-enter { opacity: 0; }
        .fade-enter-active { opacity: 1; transition: opacity 1s ease-in; }
        .fade-exit { opacity: 1; }
        .fade-exit-active { opacity: 0; transition: opacity 1s ease-out; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="h-[70px] bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 lg:px-6 shadow-lg z-10 sticky top-0">
        <div class="flex flex-col">
            <span class="text-gray-400 text-[10px] font-bold tracking-wider">ë§›ìˆëŠ” ì ì‹¬ì„ ìœ„í•œ ì—¬ì •</span>
            <h1 class="text-xl text-white leading-tight beast-font tracking-widest">ì ì‹¬ì‹œê°„ì— ì½”ì¸í•˜ê¸°</h1>
        </div>

        <!-- Stats Bar -->
        <div class="flex gap-3 lg:gap-6 text-sm bg-gray-900 px-3 lg:px-6 py-2 rounded-lg border border-gray-700 shadow-inner items-center">
            <div class="flex flex-col items-end">
                <span class="text-gray-500 text-[10px]">ê°€ìš© í˜„ê¸ˆ</span>
                <span id="cash-display" class="font-mono font-bold text-yellow-400 text-lg lg:text-xl">0</span>
            </div>
            <div class="w-px h-8 bg-gray-700 hidden sm:block"></div>
            <div class="flex flex-col items-end hidden sm:flex">
                <span class="text-gray-500 text-[10px]">í‰ê°€ ì†ìµ</span>
                <span id="total-profit-display" class="font-mono font-bold text-white text-lg lg:text-xl">0</span>
            </div>
            <div class="w-px h-8 bg-gray-700"></div>
            <div class="flex flex-col items-end justify-center min-w-[50px]">
                <span class="text-gray-500 text-[10px] mb-0.5">ë‚¨ì€ ì‹œê°„</span>
                <span id="timer-display" class="font-mono font-bold text-red-500 text-xl lg:text-2xl leading-none">00:00</span>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <main class="game-grid">
        
        <!-- 1. Coin List -->
        <section class="bg-gray-800 rounded-lg border border-gray-700 flex flex-col overflow-hidden shadow-lg col-span-1 row-span-2">
            <div class="p-2 bg-gray-900 border-b border-gray-700 font-bold text-gray-300 flex justify-between items-center text-sm">
                <span>ì‹¤ì‹œê°„ ì‹œì„¸</span>
            </div>
            <div id="stock-list" class="flex-1 overflow-y-auto p-1 space-y-1">
                <!-- Stock Items -->
            </div>
        </section>

        <!-- 2. Chart -->
        <section class="bg-gray-800 rounded-lg border border-gray-700 flex flex-col shadow-lg col-span-1 row-span-1 relative">
            <!-- Chart Header -->
            <div class="px-4 py-2 bg-gray-900 border-b border-gray-700 flex justify-between items-center h-14">
                <div>
                    <div class="flex items-baseline gap-2">
                        <h2 id="selected-name" class="text-lg font-black text-white">ì½”ì¸ì„ íƒ</h2>
                        <span id="selected-code" class="text-xs text-gray-500">KRW-???</span>
                    </div>
                </div>
                <div class="text-right flex flex-col">
                    <span id="selected-price" class="text-2xl font-mono font-bold text-white leading-none">0</span>
                    <span id="selected-change" class="text-xs font-bold text-right">0%</span>
                </div>
            </div>

            <!-- Chart Area -->
            <div class="flex-1 relative bg-gray-900 w-full h-full overflow-hidden group">
                <canvas id="price-chart" class="w-full h-full absolute top-0 left-0 cursor-crosshair"></canvas>
            </div>
        </section>

        <!-- 3. Order Panel -->
        <section class="bg-gray-800 rounded-lg border border-gray-700 flex flex-col shadow-lg col-span-1 row-span-2">
            <div class="p-2 bg-gray-900 border-b border-gray-700 font-bold text-gray-300 text-sm">
                ì£¼ë¬¸
            </div>
            
            <!-- Order Form -->
            <div class="p-4 flex flex-col gap-3 border-b border-gray-700 bg-gray-800">
                <!-- Price Input & Quick Buttons -->
                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>ì£¼ë¬¸ ê°€ê²©</span>
                    </div>
                    <div class="relative mb-2">
                        <input id="order-price-input" type="number" class="w-full bg-gray-900 border border-gray-600 rounded p-3 text-right font-mono text-xl text-white focus:border-blue-500 outline-none transition shadow-inner" placeholder="ê°€ê²© ì…ë ¥">
                        <span class="absolute left-3 top-3.5 text-gray-500 text-sm">â‚©</span>
                    </div>
                    <!-- Quick Action Buttons -->
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="game.adjustPrice(-10)" class="bg-gray-700 hover:bg-blue-900/50 text-blue-400 border border-gray-600 rounded py-2 text-xs font-bold transition">-10%</button>
                        <button onclick="game.setOrderPriceToCurrent()" class="bg-gray-700 hover:bg-gray-600 text-white border border-gray-600 rounded py-2 text-xs font-bold transition">í˜„ì¬ê°€</button>
                        <button onclick="game.adjustPrice(10)" class="bg-gray-700 hover:bg-red-900/50 text-red-400 border border-gray-600 rounded py-2 text-xs font-bold transition">+10%</button>
                    </div>
                </div>

                <!-- Quantity Select -->
                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>ì£¼ë¬¸ ìˆ˜ëŸ‰ (ë³´ìœ : <span id="holding-qty" class="text-white font-bold">0</span>ê°œ)</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button onclick="game.setQuantity(0.5)" id="btn-50" class="qty-btn py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded text-xs font-bold border border-gray-600 transition">50%</button>
                        <button onclick="game.setQuantity(1.0)" id="btn-100" class="qty-btn py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded text-xs font-bold border border-gray-600 transition">100%</button>
                    </div>
                </div>

                <!-- Buy/Sell Buttons (Moved closer) -->
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="game.placeOrder('buy')" class="bg-red-600 hover:bg-red-500 text-white py-4 rounded-lg font-black text-lg shadow-lg transition transform active:scale-95 border-b-4 border-red-800 hover:border-red-700 active:border-b-0 active:translate-y-1">
                        ë§¤ìˆ˜
                    </button>
                    <button onclick="game.placeOrder('sell')" class="bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-lg font-black text-lg shadow-lg transition transform active:scale-95 border-b-4 border-blue-800 hover:border-blue-700 active:border-b-0 active:translate-y-1">
                        ë§¤ë„
                    </button>
                </div>
            </div>

            <!-- Active Orders List -->
            <div class="flex-1 min-h-[100px] flex flex-col overflow-hidden bg-gray-900/30">
                <div class="px-3 py-2 bg-gray-900 border-b border-t border-gray-700 text-[10px] text-gray-400 font-bold uppercase tracking-wider flex justify-between items-center">
                    <span>ë¯¸ì²´ê²° ì£¼ë¬¸</span>
                    <span class="text-gray-600">Pending Orders</span>
                </div>
                <div id="order-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                    <!-- Orders go here -->
                </div>
            </div>
        </section>

        <!-- 4. Portfolio -->
        <section class="bg-gray-800 rounded-lg border border-gray-700 flex flex-col overflow-hidden shadow-lg col-span-1 row-span-1">
            <div class="p-2 bg-gray-900 border-b border-gray-700 font-bold text-gray-300 text-xs flex justify-between">
                <span>í¬íŠ¸í´ë¦¬ì˜¤</span>
            </div>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-left text-xs">
                    <thead class="text-gray-500 bg-gray-900/50 sticky top-0">
                        <tr>
                            <th class="p-3 font-normal">ì½”ì¸ëª…</th>
                            <th class="p-3 text-right font-normal">ë³´ìœ ìˆ˜ëŸ‰</th>
                            <th class="p-3 text-right font-normal">í‰ë‹¨ê°€</th>
                            <th class="p-3 text-right font-normal">ì´ ë§¤ìˆ˜ê¸ˆì•¡</th>
                            <th class="p-3 text-right font-normal">í‰ê°€ì†ìµ</th>
                        </tr>
                    </thead>
                    <tbody id="portfolio-table" class="divide-y divide-gray-700 cursor-pointer">
                        <!-- Rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- INTRO SCREEN -->
    <div id="intro-overlay" class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center cursor-pointer">
        <div id="intro-content" class="text-center transition-opacity duration-1000 px-4">
            <!-- JS Injected Content -->
        </div>
        <div class="absolute bottom-10 text-gray-500 text-sm animate-pulse">í™”ë©´ì„ í´ë¦­í•˜ë©´ ìŠ¤í‚µí•©ë‹ˆë‹¤</div>
    </div>

    <!-- TUTORIAL MODAL -->
    <div id="tutorial-overlay" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden backdrop-blur-sm">
        <div class="bg-gray-800 w-full max-w-lg rounded-2xl border border-gray-600 shadow-2xl overflow-hidden m-4">
            <div class="bg-gray-900 p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white beast-font">ì´ˆê°„ë‹¨ ê°€ì´ë“œ</h3>
            </div>
            <div class="p-6 space-y-6">
                <div class="flex items-start gap-4">
                    <div class="bg-gray-700 p-2 rounded text-2xl">ğŸ“ˆ</div>
                    <div>
                        <h4 class="font-bold text-yellow-400">ì €ì  ë§¤ìˆ˜, ê³ ì  ë§¤ë„</h4>
                        <p class="text-sm text-gray-300 mt-1">ìŒ€ ë•Œ ì‚¬ì„œ ë¹„ìŒ€ ë•Œ íŒŒì„¸ìš”. ì°¨íŠ¸ì— ì´ˆë¡ìƒ‰ ì ì„ ìœ¼ë¡œ <span class="text-green-400 font-bold">ë‚´ í‰ë‹¨ê°€</span>ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4">
                    <div class="bg-gray-700 p-2 rounded text-2xl">ğŸ’¸</div>
                    <div>
                        <h4 class="font-bold text-blue-400">ìˆ˜ëŸ‰ ì¡°ì ˆ & ë§¤ë§¤</h4>
                        <p class="text-sm text-gray-300 mt-1">50%, 100% ë²„íŠ¼ìœ¼ë¡œ ë¹ ë¥´ê²Œ ìˆ˜ëŸ‰ì„ ì¡ê³  ë§¤ìˆ˜/ë§¤ë„ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4">
                    <div class="bg-gray-700 p-2 rounded text-2xl">âš ï¸</div>
                    <div>
                        <h4 class="font-bold text-red-500">ìƒì¥íì§€ ì£¼ì˜</h4>
                        <p class="text-sm text-gray-300 mt-1">ì½”ì¸ ê°€ê²©ì´ <span class="text-red-500 font-bold">300ì› ë¯¸ë§Œ</span>ìœ¼ë¡œ ë–¨ì–´ì§€ë©´ ì¦‰ì‹œ ì‚­ì œë˜ê³  íœ´ì§€ì¡°ê°ì´ ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700">
                <button onclick="game.finishTutorial()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg text-lg transition shadow-lg">
                    ì•Œê² ìŠµë‹ˆë‹¤, ì‹œì‘í•©ë‹ˆë‹¤!
                </button>
            </div>
        </div>
    </div>

    <!-- RESULT MODAL -->
    <div id="result-modal" class="fixed inset-0 bg-black/90 z-40 flex items-center justify-center backdrop-blur-sm" style="display: none;">
        <div class="bg-gray-800 p-8 rounded-2xl border border-gray-600 max-w-md w-full text-center shadow-2xl transform transition-all scale-100 mx-4">
            <h2 id="modal-title" class="text-3xl lg:text-4xl text-white mb-2 tracking-tighter beast-font text-red-500">ê²Œì„ ì¢…ë£Œ</h2>
            <div id="modal-desc" class="my-6 space-y-4 text-sm text-gray-300">
                <!-- Result Content -->
            </div>
            <button onclick="game.resetAndStart()" id="modal-btn" class="w-full bg-gradient-to-r from-red-700 to-red-600 hover:from-red-600 hover:to-red-500 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg transition-all transform hover:scale-[1.02] ring-2 ring-red-900">
                ë‹¤ì‹œ ë„ì „í•˜ê¸°
            </button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl border border-gray-600 opacity-0 pointer-events-none transition-opacity duration-300 z-50 font-bold text-sm flex items-center gap-2 text-center w-max max-w-[90%]">
        <span id="toast-msg">ë©”ì‹œì§€</span>
    </div>

    <script>
        // --- Game Config ---
        const CONFIG = {
            initialMoney: 1000000,
            timeLimitSeconds: 180, 
            tickRate: 250, // 0.25ì´ˆ (ì ì ˆí•œ ë¦¬ë“¬ê°)
            historyLength: 100, // ì°¨íŠ¸ ê¸¸ì´
            delistPrice: 300
        };

        const INITIAL_STOCKS = [
            { name: "ì‹œë…•ì½”ì¸", code: "SYC-KRW", basePrice: 3000, volatility: 0.04 },
            { name: "ë¬´ë¯¼ë„¤íŠ¸ì›Œí¬", code: "MMN-KRW", basePrice: 4000, volatility: 0.05 },
            { name: "í–í”„ë°•ìŠ¤", code: "HFB-KRW", basePrice: 800, volatility: 0.08 },
            { name: "ì‹œì¹´ë¬´ìš”", code: "CKY-KRW", basePrice: 400, volatility: 0.1 },
            { name: "ë¡œë³´ê°“", code: "RBG-KRW", basePrice: 5000, volatility: 0.06 },
            { name: "ë§ˆëŠ˜ë„¤íŠ¸ì›Œí¬", code: "GAR-KRW", basePrice: 1500, volatility: 0.09 },
            { name: "ë¶„íƒ•ì½”ì¸", code: "BTG-KRW", basePrice: 4000, volatility: 0.4 },
        ];

        // ëœë¤ ìƒì„±ìš© ì´ë¦„ íŒŒì¸ 
        const NAME_PREFIXES = [
            { ko: "ë¶„íƒ•", en: "BT" }, { ko: "ì™€", en: "WA" }, { ko: "ë¯¸ë‹ˆ", en: "MINI" }, { ko: "í‚¤í‚¤", en: "KIKI" },
            { ko: "ë¬´ë¯¼", en: "MM" }, { ko: "ê°ˆë¦­", en: "GALIC" }, { ko: "ìŠ¤í†°", en: "STORM" }, { ko: "MIPC", en: "MIPC" },
            { ko: "ì‹œë…•", en: "SY" }, { ko: "í–í”„", en: "HAPP" }, { ko: "ì˜¬ë¦¬ë¸Œ", en: "OLIVE" }, { ko: "ì§„ì›", en: "JW" },
            { ko: "ê³ ì•¼ì´", en: "GOY" }, { ko: "ìŠ¤ì¹˜", en: "SCH" }, { ko: "ë¼íˆ¬", en: "RATU" }, { ko: "ì½”ë””", en: "CODY" },
            { ko: "ì‹œì¹´", en: "SK" }, { ko: "ì—í”„ë§ˆìŠ¤", en: "FMAS" }, { ko: "ê²Œì„", en: "GAME" }, { ko: "ì½”ì¸", en: "COIN" },
            { ko: "ë¸Œë ˆì¸", en: "BRAIN" }, { ko: "ë¡œë™", en: "ROD" }, { ko: "ìˆ˜ë°•", en: "WAT" }, { ko: "ë¼íƒ•", en: "RAT" },
            { ko: "ë¡œë³´", en: "ROBO" }, { ko: "ë§ˆëŠ˜", en: "GAL" }, { ko: "ë©œë¡ ", en: "MELON" }, { ko: "ë°±í•™", en: "WHT" }
        ];

        const NAME_SUFFIXES = [
            { ko: "ì½”ì¸", en: "C" }, { ko: "í† í°", en: "TK" }, { ko: "ìºì‹œ", en: "CASH" }, { ko: "ê³¨ë“œ", en: "GLD" },
            { ko: "ë¬´ìš”", en: "MUYO" }, { ko: "í´ë˜ì‹", en: "CLS" }, { ko: "í† ìŠ¤íŠ¸", en: "TOAST" }, { ko: "ë„¤íŠ¸ì›Œí¬", en: "NET" },
            { ko: "í”„ë¡œí† ì½œ", en: "PRO" }, { ko: "ì²´ì¸", en: "CHN" }, { ko: "íŒŒì´ë‚¸ìŠ¤", en: "FI" }, { ko: "ìŠ¤ì™‘", en: "SWP" },
            { ko: "ê°“", en: "G" }, { ko: "ê²Œì„", en: "GAME" }, { ko: "ë©œë¡ ", en: "MELON" }, { ko: "ë¯¹ìŠ¤", en: "MIX" },
            { ko: "ìŠ¤í…Œì´ì…˜", en: "STN" }, { ko: "ë¸”ë¡", en: "BLK" }, { ko: "ë°•ìŠ¤", en: "BOX" }, { ko: "", en: "" }
        ];

        class Game {
            constructor() {
                this.money = CONFIG.initialMoney;
                this.timeLeft = CONFIG.timeLimitSeconds;
                this.stocks = []; 
                this.portfolio = {}; 
                this.orders = []; 
                this.orderIdCounter = 1;
                this.stockIdCounter = 0; 
                
                this.selectedStockId = null; 
                this.selectedQtyPercent = 0.5;

                this.isPlaying = false;
                this.isIntroSkipped = false;
                this.tickInterval = null;
                this.timerInterval = null;
                this.history = {}; 
                
                this.els = {
                    cash: document.getElementById('cash-display'),
                    totalProfit: document.getElementById('total-profit-display'),
                    timer: document.getElementById('timer-display'),
                    stockList: document.getElementById('stock-list'),
                    selectedName: document.getElementById('selected-name'),
                    selectedCode: document.getElementById('selected-code'),
                    selectedPrice: document.getElementById('selected-price'),
                    selectedChange: document.getElementById('selected-change'),
                    holdingQty: document.getElementById('holding-qty'),
                    portfolioTable: document.getElementById('portfolio-table'),
                    orderList: document.getElementById('order-list'),
                    orderPriceInput: document.getElementById('order-price-input'),
                    introOverlay: document.getElementById('intro-overlay'),
                    introContent: document.getElementById('intro-content'),
                    tutorialOverlay: document.getElementById('tutorial-overlay'),
                    resultModal: document.getElementById('result-modal'),
                    modalTitle: document.getElementById('modal-title'),
                    canvas: document.getElementById('price-chart'),
                    toast: document.getElementById('toast'),
                    toastMsg: document.getElementById('toast-msg')
                };

                this.ctx = this.els.canvas.getContext('2d');
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());

                // Intro Click to Skip
                this.els.introOverlay.addEventListener('click', () => {
                    this.isIntroSkipped = true;
                });

                this.runIntro();
            }

            async runIntro() {
                const content = this.els.introContent;
                const wait = (ms) => new Promise(r => {
                    const start = Date.now();
                    const check = setInterval(() => {
                        if (this.isIntroSkipped || Date.now() - start >= ms) {
                            clearInterval(check);
                            r();
                        }
                    }, 100);
                });

                if (!this.isIntroSkipped) {
                    content.innerHTML = `<p class="text-xl lg:text-2xl font-bold text-white">"ë‹ˆë“¤ì€ ì½”ì¸ê°™ì€ ê±° í•˜ì§€ ë§ˆë¼"</p><p class="text-sm text-gray-400 mt-4">- ë¬´ ë¯¼ -</p>`;
                    await wait(2000);
                }
                
                if (this.isIntroSkipped) {
                    this.showTutorial();
                    return;
                }

                content.style.opacity = 0;
                await wait(1000);

                if (this.isIntroSkipped) {
                    this.showTutorial();
                    return;
                }

                content.style.opacity = 1;
                content.innerHTML = `<p class="text-lg lg:text-xl text-white font-medium">ë³¸ ê²Œì„ì€ ì‹¤í™”ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
                await wait(2000);

                if (this.isIntroSkipped) {
                    this.showTutorial();
                    return;
                }

                content.style.opacity = 0;
                await wait(1000);

                if (this.isIntroSkipped) {
                    this.showTutorial();
                    return;
                }

                this.showTutorial();
            }

            showTutorial() {
                this.els.introOverlay.style.display = 'none';
                this.els.tutorialOverlay.classList.remove('hidden');
            }

            finishTutorial() {
                this.els.tutorialOverlay.classList.add('hidden');
                this.start();
            }

            start() {
                this.resetAndStartGameLogic();
            }

            resetAndStart() {
                this.els.resultModal.style.display = 'none';
                this.resetAndStartGameLogic();
            }

            resetAndStartGameLogic() {
                this.isPlaying = true;
                this.money = CONFIG.initialMoney;
                this.timeLeft = CONFIG.timeLimitSeconds;
                this.initGameData();
                
                this.renderStockList();
                if (this.stocks.length > 0) {
                    this.selectStock(this.stocks[0].id);
                }
                this.setQuantity(0.5);

                if (this.tickInterval) clearInterval(this.tickInterval);
                if (this.timerInterval) clearInterval(this.timerInterval);

                this.tickInterval = setInterval(() => this.tick(), CONFIG.tickRate);
                this.timerInterval = setInterval(() => this.updateTimer(), 1000);
                this.showToast("ê±°ë˜ì†Œ ê°œì¥! í–‰ìš´ì„ ë¹•ë‹ˆë‹¤.");
                this.updateUI();
            }

            resizeCanvas() {
                const rect = this.els.canvas.parentElement.getBoundingClientRect();
                this.els.canvas.width = rect.width;
                this.els.canvas.height = rect.height;
                if (this.isPlaying && this.selectedStockId !== null) this.drawChart();
            }

            initGameData() {
                this.stocks = [];
                this.history = {};
                this.portfolio = {};
                this.orders = [];
                this.stockIdCounter = 0;

                INITIAL_STOCKS.forEach(template => {
                    this.addNewStock(template);
                });
            }

            addNewStock(template = null) {
                const id = this.stockIdCounter++;
                let stockData;

                if (template) {
                    stockData = { ...template };
                } else {
                    const prefix = NAME_PREFIXES[Math.floor(Math.random() * NAME_PREFIXES.length)];
                    const suffix = NAME_SUFFIXES[Math.floor(Math.random() * NAME_SUFFIXES.length)];
                    
                    stockData = {
                        name: prefix.ko + suffix.ko,
                        code: `${prefix.en}${suffix.en}-KRW`,
                        basePrice: Math.floor(300 + Math.random() * 10000),
                        volatility: 0.03 + (Math.random() * 0.6)
                    };
                }

                // Momentum ê¸°ë°˜ ì•Œê³ ë¦¬ì¦˜ì„ ìœ„í•œ ì†ì„± ì¶”ê°€
                const stock = {
                    id: id,
                    ...stockData,
                    currentPrice: stockData.basePrice,
                    prevPrice: stockData.basePrice,
                    
                    // ì„¸ë ¥ íŒ¨í„´ ì‹œìŠ¤í…œ
                    phase: 'normal', // normal, accumulation, pump, dump
                    phaseTimer: 0,
                    
                    // ê´€ì„± ë° í˜
                    momentum: 0, // í˜„ì¬ ìƒìŠ¹/í•˜ë½ í˜
                };

                this.stocks.push(stock);
                this.history[id] = new Array(CONFIG.historyLength).fill(stock.basePrice);
                this.portfolio[id] = { count: 0, avgPrice: 0 };
                
                return stock;
            }

            gameOver() {
                this.isPlaying = false;
                clearInterval(this.tickInterval);
                clearInterval(this.timerInterval);
                
                const finalMoney = this.getTotalValuation();
                const profit = finalMoney - CONFIG.initialMoney;
                
                let menu = "";
                let message = "";
                let color = "";

                if (finalMoney < 100000) {
                    menu = "ìš¸ë©´ì„œ ì“°ëŸ¬ì§";
                    message = "ì—„ë§ˆ ë¯¸ì•ˆí•´ã… ã… ã… ã… ã… ";
                    color = "text-gray-500"; 
                } 
                else if (finalMoney < 500000) {
                    menu = "ë„Œ ì¢€ êµ¶ì–´ë¼ã…‹ã…‹";
                    message = "ì¼.. ì—´ì‹¬íˆ í•´ì•¼ê² ì§€?";
                    color = "text-blue-900"; 
                }
                else if (finalMoney < 800000) {
                    menu = "ì½œë¼ í•œ ìº”";
                    message = "ëª©ì´ ì¹¼ì¹¼í•˜ë‹¤.. íƒ„ì‚° ë•Œë¬¸ì€ ì•„ë‹Œ ê±° ê°™ë‹¤";
                    color = "text-blue-700"; 
                }
                else if (finalMoney < 950000) {
                    menu = "ì»µë¼ë©´";
                    message = "ë‹¤ìŒì—” ì˜ ë˜ì§€ ì•Šì„ê¹Œ?";
                    color = "text-blue-400"; 
                }
                else if (finalMoney < 1000000) {
                    menu = "í¸ì˜ì  ë„ì‹œë½";
                    message = "ê·¸ëƒ¥ì €ëƒ¥ ë¨¹ì„ë§Œ í•˜ë‹¤";
                    color = "text-gray-400"; 
                }
                else if (finalMoney == 1000000) {
                    menu = "ì´ê±¸ ì•ˆ í•´?";
                    message = "í•˜ë‚¨ìã…‰ã…ˆ";
                    color = "text-white"; 
                }
                else if (finalMoney < 300000) {
                    menu = "ëˆê¹ŒìŠ¤";
                    message = "ì°¸ ì¢‹ì•„í•˜ëŠ” ë©”ë‰´ë‹¤";
                    color = "text-green-300"; 
                }
                else if (finalMoney < 5000000) {
                    menu = "ì´ˆë°¥";
                    message = "ê´‘ì–´ì´ˆë°¥ì´ ì´ë ‡ê²Œ ìŒŒì—ˆë‚˜?";
                    color = "text-green-500"; 
                }
                else if (finalMoney < 10000000) {
                    menu = "ë¹„ì‹¸ê³  ë§›ìˆëŠ” ê³¼ì¼";
                    message = "ì—­ì‹œ ì„¸ìƒì— ì‹¸ê³  ë§›ìˆëŠ” ê³¼ì¼ì€ ì—†ì§€";
                    color = "text-yellow-400"; 
                }
                else if (finalMoney < 30000000) {
                    menu = "ìµœì‹ í˜• ì•„ì´ë§¥ í’€ì˜µì…˜";
                    message = "ëŒ€ì‹  ë§ˆìŒì´ ë°°ë¶ˆëŸ¬ì¡Œë‹¤";
                    color = "text-orange-500"; 
                }
                else if (finalMoney < 70000000) {
                    menu = "ì¤‘í˜• ì„¸ë‹¨";
                    message = "ì—„ë§ˆ ë‚˜ ì°¨ìƒ€ì–´ ë¨¹ëŠ” ê±° ë§ê³  íƒ€ëŠ” ì°¨ ìˆì–ì•„";
                    color = "text-red-500";
                }
                else { 
                    menu = "ìœ ì¹˜ì¥ì—ì„œ ë¨¹ëŠ” ì§œì¥ë©´";
                    message = "ë„ˆ ì„¸ë ¥ì´ì§€?";
                    color = "text-purple-500"; 
                }

                this.els.modalTitle.innerHTML = `<span class='${color}'>${menu}</span>`;
                
                document.querySelector('#modal-desc').innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg">${message}</p>
                        <p class="text-2xl font-bold bg-gray-900 p-4 rounded border border-gray-700">
                            ìµœì¢… ìì‚°: <span class="${color}">${finalMoney.toLocaleString()}ì›</span><br>
                            <span class="text-sm text-gray-400 font-normal">(ìˆ˜ìµ: ${profit.toLocaleString()}ì›)</span>
                        </p>
                    </div>
                `;
                this.els.resultModal.style.display = 'flex';
            }

            updateTimer() {
                this.timeLeft--;
                const m = Math.floor(this.timeLeft / 60);
                const s = this.timeLeft % 60;
                this.els.timer.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if (this.timeLeft <= 0) this.gameOver();
            }

            tick() {
                for (let i = this.stocks.length - 1; i >= 0; i--) {
                    const stock = this.stocks[i];
                    
                    if (stock.currentPrice < CONFIG.delistPrice) {
                        this.delistStock(stock, i);
                        continue;
                    }
                    this.updateStockPrice(stock);
                }

                this.checkOrders();
                this.updateUI();
                this.drawChart();
            }

            checkBankruptcy() {
                if (this.getTotalValuation() < 5000) {
                    this.gameOver();
                }
            }

            delistStock(stock, index) {
                if (this.portfolio[stock.id].count > 0) {
                    this.portfolio[stock.id].count = 0;
                    this.portfolio[stock.id].avgPrice = 0;
                }

                for (let j = this.orders.length - 1; j >= 0; j--) {
                    const o = this.orders[j];
                    if (o.stockId === stock.id) {
                        if (o.type === 'buy') this.money += (o.price * o.qty);
                        this.orders.splice(j, 1);
                    }
                }

                const wasSelected = (this.selectedStockId === stock.id);

                this.stocks.splice(index, 1);
                delete this.history[stock.id];
                delete this.portfolio[stock.id];

                const newStock = this.addNewStock();
                this.showToast(`[ì‹ ê·œ] ${newStock.name} ê±°ë˜ ì‹œì‘`);

                if (wasSelected) {
                    if (this.stocks.length > 0) {
                        this.selectStock(this.stocks[0].id);
                    } else {
                        this.selectStock(newStock.id);
                    }
                }

                this.renderStockList();
                this.renderOrders();
                this.checkBankruptcy();
            }

            // --- ì„¸ë ¥ì£¼ ì•Œê³ ë¦¬ì¦˜ (Manipulation Logic) ---
            updateStockPrice(stock) {
                // 1. íŒ¨í„´(Phase) ê´€ë¦¬
                if (stock.phaseTimer > 0) {
                    stock.phaseTimer--;
                } else {
                    // íŒ¨í„´ ì „í™˜ í™•ë¥ 
                    const r = Math.random();
                    if (r < 0.2) {
                        stock.phase = 'normal'; // íš¡ë³´/ì¼ë°˜ ë³€ë™ (40%)
                        stock.phaseTimer = 10 + Math.floor(Math.random() * 10);
                    } else if (r < 0.5) {
                        stock.phase = 'accumulation'; // ë§¤ì§‘ (30%) - ê°€ê²© ê°€ë‘ê¸°
                        stock.phaseTimer = 15 + Math.floor(Math.random() * 15);
                    } else if (r < 0.75) {
                        stock.phase = 'pump'; // ì‘ì „ ê°œì‹œ (ìƒìŠ¹) (15%)
                        stock.phaseTimer = 10 + Math.floor(Math.random() * 10);
                    } else {
                        stock.phase = 'dump'; // ì„¤ê±°ì§€ (í•˜ë½) (15%)
                        stock.phaseTimer = 10 + Math.floor(Math.random() * 10);
                    }
                }

                // 2. í˜(Force) ê³„ì‚°
                let force = 0;
                let volatility = stock.volatility; // ê¸°ë³¸ ë³€ë™ì„±

                switch (stock.phase) {
                    case 'normal':
                        // ëœë¤ ë“±ë½
                        force = (Math.random() - 0.5) * 0.005; 
                        break;
                    case 'accumulation':
                        // ë§¤ì§‘: ê°€ê²©ì„ ì–µëˆ„ë¥´ê±°ë‚˜ ì‚´ì§ë§Œ ì˜¬ë¦¼, ë³€ë™ì„± ê°ì†Œ
                        force = (Math.random() * 0.004) - 0.001;
                        let d = Math.random();
                        if (d < 0.05) stock.phase = 'dump';
                        else if (d < 0.05) stock.phase = 'dump'; 
                        volatility *= 0.5;
                        break;
                    case 'pump':
                        // íŒí•‘: ê°•ë ¥í•œ ìƒìŠ¹ì„¸, ì¤‘ê°„ì¤‘ê°„ ì¡°ì •(ê°œë¯¸í„¸ê¸°)
                        force = 0.1 + (Math.random() * 0.15); 
                        if (Math.random() < 0.4) force = -0.09 - Math.random() * 0.05; // 20% í™•ë¥ ë¡œ ê¸‰ë½ (ê°œë¯¸í„¸ê¸°)
                        if (Math.random() < 0.02) stock.phase = 'dump';
                        volatility *= 2.0;
                        break;
                    case 'dump':
                        // ë¤í•‘: ê°•ë ¥í•œ í•˜ë½ì„¸, ì¤‘ê°„ì¤‘ê°„ ë°˜ë“±(ë°ë“œìº£)
                        force = -0.1 - (Math.random() * 0.15);
                        if (Math.random() < 0.4) force = 0.1 + Math.random() * 0.15; // 20% í™•ë¥ ë¡œ ë°˜ë“± (ì„¤ê±°ì§€)
                        if (Math.random() < 0.02) stock.phase = 'pump';
                        volatility *= 4.0;
                        break;
                }

                // 3. ê´€ì„±(Momentum) ì ìš©
                // ì´ì „ì˜ í˜ì´ 80% ìœ ì§€ë˜ê³ , ìƒˆë¡œìš´ í˜ì´ 20% ë°˜ì˜ë¨ -> ì°¨íŠ¸ê°€ ë¶€ë“œëŸ½ê²Œ ì´ì–´ì§
                stock.momentum = (stock.momentum * 0.8) + (force * 0.2);

                // 4. ë…¸ì´ì¦ˆ(Noise) ì¶”ê°€
                const noise = (Math.random() - 0.5) * volatility;

                // 5. ìµœì¢… ë“±ë½ë¥  ê²°ì •
                let changePercent = stock.momentum + noise;
                
                // ê°€ê²© ì ìš©
                stock.prevPrice = stock.currentPrice;
                stock.currentPrice = Math.floor(stock.currentPrice * (1 + changePercent));
                
                // ìµœì €ê°€ ë³´ì •
                if (stock.currentPrice < 1) stock.currentPrice = 1;

                // íˆìŠ¤í† ë¦¬ ì €ì¥
                this.history[stock.id].push(stock.currentPrice);
                if (this.history[stock.id].length > CONFIG.historyLength) {
                    this.history[stock.id].shift();
                }
            }

            // --- Order System ---
            
            setQuantity(percent) {
                this.selectedQtyPercent = percent;
                document.querySelectorAll('.qty-btn').forEach(b => b.classList.replace('bg-blue-600', 'bg-gray-700'));
                document.querySelectorAll('.qty-btn').forEach(b => b.classList.replace('text-white', 'text-gray-300'));
                
                const activeBtn = percent === 0.5 ? document.getElementById('btn-50') : document.getElementById('btn-100');
                activeBtn.classList.replace('bg-gray-700', 'bg-blue-600');
                activeBtn.classList.replace('text-gray-300', 'text-white');
            }

            setOrderPriceToCurrent() {
                const stock = this.stocks.find(s => s.id === this.selectedStockId);
                if(stock) this.els.orderPriceInput.value = stock.currentPrice;
            }

            adjustPrice(percent) {
                const stock = this.stocks.find(s => s.id === this.selectedStockId);
                if(!stock) return;
                const currentVal = stock.currentPrice;
                const newVal = Math.floor(currentVal * (1 + percent / 100));
                this.els.orderPriceInput.value = Math.max(1, newVal);
            }

            placeOrder(type) {
                if (!this.isPlaying) return;
                
                const stock = this.stocks.find(s => s.id === this.selectedStockId);
                if (!stock) return;

                const inputPrice = parseInt(this.els.orderPriceInput.value);
                if (!inputPrice || inputPrice <= 0) {
                    this.showToast("ê°€ê²©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
                    return;
                }

                let qty = 0;
                let originalAvgPrice = 0; 

                if (type === 'buy') {
                    const useMoney = Math.floor(this.money * this.selectedQtyPercent);
                    qty = Math.floor(useMoney / inputPrice);
                    if (qty <= 0) {
                        this.showToast("ì‹œë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                        return;
                    }
                    this.money -= (qty * inputPrice);

                } else {
                    const holding = this.portfolio[stock.id];
                    if (!holding || holding.count <= 0) {
                        this.showToast("ê°€ì§„ ì½”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }
                    
                    qty = Math.ceil(holding.count * this.selectedQtyPercent);
                    if (qty <= 0) return;
                    
                    originalAvgPrice = holding.avgPrice;

                    holding.count -= qty;
                    if (holding.count === 0) holding.avgPrice = 0; 
                }

                const order = {
                    id: this.orderIdCounter++,
                    stockId: stock.id,
                    stockName: stock.name,
                    type: type,
                    price: inputPrice,
                    qty: qty,
                    originalAvgPrice: originalAvgPrice, 
                    time: new Date()
                };

                this.orders.push(order);
                this.showToast(`${type === 'buy'?'ë§¤ìˆ˜':'ë§¤ë„'} ì£¼ë¬¸: ${qty}ê°œ`);
                this.renderOrders();
                this.updateUI(); 
                this.checkOrders();
            }

            checkOrders() {
                for (let i = this.orders.length - 1; i >= 0; i--) {
                    const order = this.orders[i];
                    const stock = this.stocks.find(s => s.id === order.stockId);
                    
                    if (!stock) {
                        this.orders.splice(i, 1);
                        continue;
                    }

                    const currentPrice = stock.currentPrice;
                    let executed = false;

                    if (order.type === 'buy') {
                        if (currentPrice <= order.price) {
                            const actualCost = currentPrice * order.qty;
                            const reservedCost = order.price * order.qty;
                            
                            const p = this.portfolio[stock.id];
                            const totalVal = (p.count * p.avgPrice) + reservedCost;
                            p.count += order.qty;
                            p.avgPrice = Math.floor(totalVal / p.count);
                            
                            executed = true;
                            this.showToast(`[ì²´ê²°] ${stock.name} ë§¤ìˆ˜ ì™„ë£Œ`);
                        }
                    } else {
                        if (currentPrice >= order.price) {
                            const gain = order.price * order.qty;
                            this.money += gain;
                            executed = true;
                            this.showToast(`[ì²´ê²°] ${stock.name} ë§¤ë„ ì™„ë£Œ`);
                            
                            setTimeout(() => this.checkBankruptcy(), 0);
                        }
                    }

                    if (executed) {
                        this.orders.splice(i, 1);
                        this.renderOrders();
                        this.flashEffect(order.type);
                    }
                }
            }

            cancelOrder(id) {
                const idx = this.orders.findIndex(o => o.id === id);
                if (idx === -1) return;
                
                const order = this.orders[idx];
                
                if (order.type === 'buy') {
                    this.money += (order.price * order.qty);
                } else {
                    const p = this.portfolio[order.stockId];
                    if (p) {
                        const currentVal = p.count * p.avgPrice;
                        const returnedVal = order.qty * order.originalAvgPrice;
                        
                        p.count += order.qty;
                        if (p.count > 0) {
                             p.avgPrice = Math.floor((currentVal + returnedVal) / p.count);
                        }
                    }
                }

                this.orders.splice(idx, 1);
                this.renderOrders();
                this.updateUI();
                this.showToast("ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

            showToast(msg) {
                this.els.toastMsg.textContent = msg;
                this.els.toast.classList.remove('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    this.els.toast.classList.add('opacity-0', 'pointer-events-none');
                }, 1500);
            }

            flashEffect(type) {
                const el = this.els.canvas.parentElement;
                const colorClass = type === 'buy' ? 'blink-red' : 'blink-blue';
                el.classList.add(colorClass);
                setTimeout(() => el.classList.remove(colorClass), 300);
            }

            selectStock(id) {
                const stock = this.stocks.find(s => s.id === id);
                if (!stock) return;

                this.selectedStockId = id;
                
                this.renderStockList(); 

                this.els.selectedName.textContent = stock.name;
                this.els.selectedCode.textContent = stock.code;
                this.els.orderPriceInput.value = stock.currentPrice;
                
                this.drawChart();
                this.updateSelectedInfo();
            }

            updateUI() {
                this.els.cash.textContent = Math.floor(this.money).toLocaleString();
                
                const totalVal = this.getTotalValuation();
                const profit = totalVal - CONFIG.initialMoney;
                this.els.totalProfit.textContent = `${profit > 0 ? '+' : ''}${profit.toLocaleString()}`;
                this.els.totalProfit.className = `font-mono font-bold text-lg lg:text-xl ${profit > 0 ? 'text-red-400' : (profit < 0 ? 'text-blue-400' : 'text-gray-400')}`;

                this.stocks.forEach(s => {
                    const el = document.getElementById(`stock-item-${s.id}`);
                    if (el) {
                        const priceEl = el.querySelector('.price');
                        const changeEl = el.querySelector('.change');
                        
                        priceEl.textContent = s.currentPrice.toLocaleString();
                        const change = ((s.currentPrice - s.basePrice) / s.basePrice) * 100;
                        changeEl.textContent = `${change > 0 ? '+' : ''}${change.toFixed(2)}%`;
                        
                        const colorClass = change > 0 ? 'up-color' : (change < 0 ? 'down-color' : 'text-gray-400');
                        priceEl.className = `price font-mono font-bold text-sm ${colorClass}`;
                        changeEl.className = `change text-[10px] ${colorClass}`;
                        
                        if (s.currentPrice < CONFIG.delistPrice + 200) {
                            el.classList.add('border-red-500');
                        } else {
                            el.classList.remove('border-red-500');
                        }
                    }
                });

                if (this.selectedStockId !== null) this.updateSelectedInfo();
                this.renderPortfolio();
            }

            updateSelectedInfo() {
                const s = this.stocks.find(st => st.id === this.selectedStockId);
                if (!s) return; 

                const p = this.portfolio[s.id];

                this.els.selectedPrice.textContent = s.currentPrice.toLocaleString();
                const change = ((s.currentPrice - s.basePrice) / s.basePrice) * 100;
                this.els.selectedChange.textContent = `${change > 0 ? 'â–²' : 'â–¼'} ${Math.abs(change).toFixed(2)}%`;
                this.els.selectedPrice.className = `text-2xl font-mono font-bold leading-none ${change > 0 ? 'up-color' : 'down-color'}`;
                this.els.selectedChange.className = `text-xs font-bold text-right ${change > 0 ? 'up-color' : 'down-color'}`;

                this.els.holdingQty.textContent = p ? p.count.toLocaleString() : 0;
            }

            renderStockList() {
                this.els.stockList.innerHTML = '';
                this.stocks.forEach(s => {
                    const div = document.createElement('div');
                    div.id = `stock-item-${s.id}`;
                    div.className = `stock-item p-2 rounded bg-gray-800 hover:bg-gray-700 cursor-pointer transition flex justify-between items-center border ${s.id === this.selectedStockId ? 'border-l-4 border-yellow-400 bg-gray-700' : 'border-gray-700'}`;
                    div.onclick = () => this.selectStock(s.id);
                    
                    const change = ((s.currentPrice - s.basePrice) / s.basePrice) * 100;
                    const colorClass = change > 0 ? 'up-color' : (change < 0 ? 'down-color' : 'text-gray-400');

                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-xs text-gray-300">${s.name}</div>
                        </div>
                        <div class="text-right">
                            <div class="price font-mono font-bold text-sm ${colorClass}">${s.currentPrice.toLocaleString()}</div>
                            <div class="change text-[10px] ${colorClass}">${change > 0?"+":""}${change.toFixed(2)}%</div>
                        </div>
                    `;
                    this.els.stockList.appendChild(div);
                });
            }

            renderOrders() {
                this.els.orderList.innerHTML = '';
                if (this.orders.length === 0) {
                    this.els.orderList.innerHTML = '<div class="text-center text-gray-600 text-xs mt-4">...</div>';
                    return;
                }

                [...this.orders].reverse().forEach(o => {
                    const div = document.createElement('div');
                    const typeText = o.type === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
                    const color = o.type === 'buy' ? 'text-red-400' : 'text-blue-400';
                    
                    div.className = "flex justify-between items-center bg-gray-900 p-2 rounded border border-gray-700 text-xs";
                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-gray-300">${o.stockName} <span class="${color}">${typeText}</span></div>
                            <div class="text-gray-500 font-mono">${o.price.toLocaleString()}ì› | ${o.qty}ê°œ</div>
                        </div>
                        <button onclick="game.cancelOrder(${o.id})" class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded text-[10px]">ì·¨ì†Œ</button>
                    `;
                    this.els.orderList.appendChild(div);
                });
            }

            renderPortfolio() {
                this.els.portfolioTable.innerHTML = '';
                this.stocks.forEach(s => {
                    const p = this.portfolio[s.id];
                    if (p && p.count > 0) {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-gray-700 transition border-b border-gray-700 last:border-0";
                        tr.onclick = () => this.selectStock(s.id);

                        const totalBuy = p.count * p.avgPrice;
                        const totalVal = p.count * s.currentPrice;
                        const profit = totalVal - totalBuy;
                        const profitRate = totalBuy > 0 ? (profit / totalBuy) * 100 : 0;
                        
                        const color = profit > 0 ? 'text-red-400' : (profit < 0 ? 'text-blue-400' : 'text-gray-400');
                        const sign = profit > 0 ? '+' : '';
                        
                        tr.innerHTML = `
                            <td class="p-3 font-bold text-gray-200">${s.name}</td>
                            <td class="p-3 text-right font-mono text-gray-400">${p.count.toLocaleString()}</td>
                            <td class="p-3 text-right font-mono text-gray-400">${p.avgPrice.toLocaleString()}</td>
                            <td class="p-3 text-right font-mono text-gray-300">${totalBuy.toLocaleString()}</td>
                            <td class="p-3 text-right font-mono font-bold ${color}">
                                <div>${sign}${profit.toLocaleString()}</div>
                                <div class="text-xs opacity-75">${profitRate.toFixed(2)}%</div>
                            </td>
                        `;
                        this.els.portfolioTable.appendChild(tr);
                    }
                });
            }

            getTotalValuation() {
                let stockVal = 0;
                this.stocks.forEach(s => {
                    if(this.portfolio[s.id]) {
                        stockVal += this.portfolio[s.id].count * s.currentPrice;
                    }
                });
                
                let orderEscrow = 0;
                this.orders.forEach(o => {
                    if (o.type === 'buy') orderEscrow += (o.price * o.qty);
                });
                
                return Math.floor(this.money + orderEscrow + stockVal);
            }

            drawChart() {
                if (!this.els.canvas || this.selectedStockId === null) return;
                const ctx = this.ctx;
                const w = this.els.canvas.width;
                const h = this.els.canvas.height;
                const history = this.history[this.selectedStockId];
                
                if (!history) return; 

                ctx.fillStyle = '#111827';
                ctx.fillRect(0,0,w,h);
                
                // Grid
                ctx.strokeStyle = '#374151'; 
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                for(let i=1; i<4; i++) {
                    const y = h * (i/4);
                    ctx.moveTo(0, y);
                    ctx.lineTo(w, y);
                }
                ctx.stroke();

                let min = Math.min(...history);
                let max = Math.max(...history);
                const padding = (max - min) * 0.3; 
                min -= padding;
                max += padding;
                
                if (min > CONFIG.delistPrice && min < CONFIG.delistPrice + 500) {
                     min = CONFIG.delistPrice - 50;
                }
                
                if (min === max) { max += 10; min -= 10; } 

                const mapY = (val) => h - ((val - min) / (max - min)) * h;

                // Delist Line
                const delistY = mapY(CONFIG.delistPrice);
                if (delistY < h && delistY > 0) {
                    ctx.fillStyle = 'rgba(220, 38, 38, 0.1)'; 
                    ctx.fillRect(0, delistY, w, h - delistY);
                    ctx.beginPath();
                    ctx.strokeStyle = '#ef4444';
                    ctx.setLineDash([4, 4]);
                    ctx.moveTo(0, delistY);
                    ctx.lineTo(w, delistY);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    ctx.fillStyle = '#ef4444';
                    ctx.font = '10px sans-serif';
                    ctx.fillText('ìƒì¥íì§€ ë¼ì¸ (300ì›)', 5, delistY - 5);
                }

                // Chart Line
                const lineColor = history[history.length-1] >= history[0] ? '#ff4d4d' : '#4d79ff';
                ctx.beginPath();
                ctx.lineWidth = 2.5;
                ctx.strokeStyle = lineColor;
                ctx.lineJoin = 'round';

                const step = w / (CONFIG.historyLength - 1);
                
                history.forEach((p, i) => {
                    const x = i * step;
                    const y = mapY(p);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();

                // Gradient Fill
                const grad = ctx.createLinearGradient(0, 0, 0, h);
                grad.addColorStop(0, lineColor + '33'); 
                grad.addColorStop(1, lineColor + '00'); 
                
                ctx.lineTo(w, h);
                ctx.lineTo(0, h);
                ctx.fillStyle = grad;
                ctx.fill();

                // Order Lines
                const sId = this.selectedStockId;
                this.orders.forEach(o => {
                    if (o.stockId === sId) {
                        const y = mapY(o.price);
                        if (y >= 0 && y <= h) {
                            ctx.beginPath();
                            ctx.strokeStyle = o.type === 'buy' ? '#f87171' : '#60a5fa'; 
                            ctx.lineWidth = 1;
                            ctx.setLineDash([2, 2]);
                            ctx.moveTo(0, y);
                            ctx.lineTo(w, y);
                            ctx.stroke();
                            ctx.setLineDash([]);
                        }
                    }
                });

                // Average Price Line (í‰ë‹¨ê°€)
                const portfolioItem = this.portfolio[sId];
                if (portfolioItem && portfolioItem.count > 0 && portfolioItem.avgPrice > 0) {
                    const avgY = mapY(portfolioItem.avgPrice);
                    if (avgY >= 0 && avgY <= h) {
                        ctx.beginPath();
                        ctx.strokeStyle = '#4ade80'; // Green
                        ctx.lineWidth = 1.5;
                        ctx.setLineDash([5, 3]);
                        ctx.moveTo(0, avgY);
                        ctx.lineTo(w, avgY);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        ctx.fillStyle = '#4ade80';
                        ctx.font = 'bold 11px sans-serif';
                        ctx.fillText(`ë‚´ í‰ë‹¨ê°€: ${portfolioItem.avgPrice.toLocaleString()}`, 5, avgY - 5);
                    }
                }

                // Current Price Dot
                const lastY = mapY(history[history.length-1]);
                ctx.beginPath();
                ctx.arc(w - 4, lastY, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
            }
        }

        const game = new Game();
    </script>
</body>
</html>
